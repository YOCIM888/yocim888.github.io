<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>经典魂斗罗</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #111;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .game-header {
            width: 800px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #222;
            border-radius: 5px;
        }
        
        .game-title {
            color: #ff3300;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 10px #ff3300;
        }
        
        .game-container {
            position: relative;
            width: 800px;
            height: 500px;
            background-color: #000;
            border: 2px solid #444;
            overflow: hidden;
            background-image: 
                linear-gradient(transparent 95%, rgba(0, 100, 0, 0.2) 95%),
                linear-gradient(90deg, transparent 95%, rgba(0, 100, 0, 0.2) 95%);
            background-size: 40px 40px;
        }
        
        .player {
            position: absolute;
            width: 30px;
            height: 40px;
            background-color: #00aaff;
            border-radius: 5px;
            z-index: 10;
            transition: left 0.1s, top 0.1s;
        }
        
        .player::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 15px;
            background-color: #0066cc;
            top: -10px;
            left: 10px;
            border-radius: 3px 3px 0 0;
        }
        
        .bullet {
            position: absolute;
            width: 8px;
            height: 4px;
            background-color: #ffff00;
            border-radius: 2px;
            z-index: 5;
        }
        
        .enemy {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ff3300;
            border-radius: 50%;
            z-index: 5;
        }
        
        .enemy::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #990000;
            top: 5px;
            left: 10px;
            border-radius: 50%;
        }
        
        .boss {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: #9900ff;
            border-radius: 10px;
            z-index: 3;
        }
        
        .boss::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #6600cc;
            top: 10px;
            left: 30px;
            border-radius: 50%;
        }
        
        .platform {
            position: absolute;
            background-color: #663300;
            border-radius: 5px;
        }
        
        .power-up {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #ffff00;
            border-radius: 50%;
            animation: pulse 1s infinite;
            z-index: 4;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .explosion {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: #ff9900;
            border-radius: 50%;
            animation: explode 0.5s forwards;
            z-index: 15;
        }
        
        @keyframes explode {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 800px;
            margin-top: 10px;
            padding: 10px;
            background-color: #222;
            border-radius: 5px;
        }
        
        .controls {
            margin-top: 15px;
            width: 800px;
            display: flex;
            justify-content: space-between;
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
        }
        
        .controls div {
            margin: 0 5px;
        }
        
        .key {
            display: inline-block;
            background-color: #555;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 0 3px;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .hidden {
            display: none;
        }
        
        button {
            background-color: #ff3300;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        button:hover {
            background-color: #ff5500;
        }
        
        .lives {
            display: flex;
            align-items: center;
        }
        
        .life-icon {
            width: 20px;
            height: 20px;
            background-color: #00aaff;
            margin: 0 3px;
            border-radius: 3px;
            position: relative;
        }
        
        .life-icon::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 8px;
            background-color: #0066cc;
            top: -5px;
            left: 7px;
            border-radius: 2px 2px 0 0;
        }
        
        .upgrade-indicator {
            position: absolute;
            top: -20px;
            left: 0;
            color: #ffff00;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 3px #000;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="game-header">
        <div class="game-title">魂斗罗 CONTRA</div>
        <div>关卡: <span id="level">1</span></div>
    </div>
    
    <div class="game-container" id="gameContainer">
        <!-- 游戏元素将通过JavaScript动态生成 -->
        <div id="player" class="player"></div>
        
        <div id="gameOverScreen" class="game-over hidden">
            <h1>游戏结束</h1>
            <p>得分: <span id="finalScore">0</span></p>
            <p>最高分: <span id="highScore">0</span></p>
            <button id="restartButton">重新开始</button>
        </div>
    </div>
    
    <div class="game-info">
        <div>得分: <span id="score">0</span></div>
        <div class="lives">
            生命: 
            <div id="livesContainer"></div>
        </div>
        <div>武器: <span id="weapon">基本枪</span></div>
        <div>敌人剩余: <span id="enemiesLeft">10</span></div>
    </div>
    
    <div class="controls">
        <div>移动: <span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span></div>
        <div>射击: <span class="key">J</span></div>
        <div>跳跃: <span class="key">K</span></div>
        <div>开始: <span class="key">Enter</span></div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            player: {
                x: 100,
                y: 350,
                width: 30,
                height: 40,
                speed: 5,
                jumpHeight: 15,
                isJumping: false,
                jumpCount: 0,
                direction: 'right',
                weapon: 'basic',
                weaponLevel: 1,
                lives: 3,
                invincible: false,
                invincibleTimer: 0
            },
            bullets: [],
            enemies: [],
            platforms: [],
            powerUps: [],
            explosions: [],
            boss: null,
            score: 0,
            highScore: localStorage.getItem('contraHighScore') || 0,
            level: 1,
            enemiesLeft: 10,
            gameRunning: true,
            keys: {}
        };

        // 获取DOM元素
        const gameContainer = document.getElementById('gameContainer');
        const player = document.getElementById('player');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const enemiesLeftElement = document.getElementById('enemiesLeft');
        const weaponElement = document.getElementById('weapon');
        const livesContainer = document.getElementById('livesContainer');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const highScoreElement = document.getElementById('highScore');
        const restartButton = document.getElementById('restartButton');

        // 初始化游戏
        function initGame() {
            // 重置游戏状态
            gameState.player.x = 100;
            gameState.player.y = 350;
            gameState.player.lives = 3;
            gameState.player.weapon = 'basic';
            gameState.player.weaponLevel = 1;
            gameState.bullets = [];
            gameState.enemies = [];
            gameState.powerUps = [];
            gameState.explosions = [];
            gameState.boss = null;
            gameState.score = 0;
            gameState.level = 1;
            gameState.enemiesLeft = 10;
            gameState.gameRunning = true;
            
            // 更新UI
            scoreElement.textContent = gameState.score;
            levelElement.textContent = gameState.level;
            enemiesLeftElement.textContent = gameState.enemiesLeft;
            weaponElement.textContent = '基本枪';
            updateLivesDisplay();
            gameOverScreen.classList.add('hidden');
            
            // 创建平台
            createPlatforms();
            
            // 创建初始敌人
            createEnemies();
            
            // 放置玩家
            updatePlayerPosition();
            
            // 开始游戏循环
            gameLoop();
        }

        // 创建平台
        function createPlatforms() {
            gameState.platforms = [
                {x: 0, y: 450, width: 800, height: 50}, // 地面
                {x: 100, y: 350, width: 150, height: 20},
                {x: 300, y: 300, width: 100, height: 20},
                {x: 500, y: 250, width: 150, height: 20},
                {x: 200, y: 200, width: 100, height: 20},
                {x: 400, y: 150, width: 150, height: 20}
            ];
            
            // 清除现有的平台
            document.querySelectorAll('.platform').forEach(p => p.remove());
            
            // 创建平台DOM元素
            gameState.platforms.forEach(platform => {
                const platformElement = document.createElement('div');
                platformElement.className = 'platform';
                platformElement.style.left = `${platform.x}px`;
                platformElement.style.top = `${platform.y}px`;
                platformElement.style.width = `${platform.width}px`;
                platformElement.style.height = `${platform.height}px`;
                gameContainer.appendChild(platformElement);
            });
        }

        // 创建敌人
        function createEnemies() {
            // 清除现有敌人
            document.querySelectorAll('.enemy').forEach(e => e.remove());
            gameState.enemies = [];
            
            // 根据关卡创建敌人
            const enemyCount = 5 + gameState.level * 2;
            gameState.enemiesLeft = enemyCount;
            enemiesLeftElement.textContent = gameState.enemiesLeft;
            
            for (let i = 0; i < enemyCount; i++) {
                const enemy = {
                    x: Math.random() * 700 + 50,
                    y: Math.random() * 200 + 50,
                    width: 30,
                    height: 30,
                    speedX: Math.random() * 2 + 1,
                    speedY: 0,
                    direction: Math.random() > 0.5 ? 1 : -1,
                    health: 1,
                    type: 'normal'
                };
                
                gameState.enemies.push(enemy);
                
                const enemyElement = document.createElement('div');
                enemyElement.className = 'enemy';
                enemyElement.style.left = `${enemy.x}px`;
                enemyElement.style.top = `${enemy.y}px`;
                enemyElement.id = `enemy-${i}`;
                gameContainer.appendChild(enemyElement);
            }
            
            // 每3关生成一个Boss
            if (gameState.level % 3 === 0) {
                createBoss();
            }
        }

        // 创建Boss
        function createBoss() {
            gameState.boss = {
                x: 400,
                y: 50,
                width: 80,
                height: 80,
                health: 10 + gameState.level,
                maxHealth: 10 + gameState.level,
                speedX: 1,
                direction: 1
            };
            
            const bossElement = document.createElement('div');
            bossElement.className = 'boss';
            bossElement.style.left = `${gameState.boss.x}px`;
            bossElement.style.top = `${gameState.boss.y}px`;
            bossElement.id = 'boss';
            gameContainer.appendChild(bossElement);
            
            // Boss出现时增加敌人数量
            gameState.enemiesLeft += 1;
            enemiesLeftElement.textContent = gameState.enemiesLeft;
        }

        // 更新玩家位置
        function updatePlayerPosition() {
            player.style.left = `${gameState.player.x}px`;
            player.style.top = `${gameState.player.y}px`;
            
            // 更新玩家方向
            if (gameState.player.direction === 'left') {
                player.style.transform = 'scaleX(-1)';
            } else {
                player.style.transform = 'scaleX(1)';
            }
            
            // 无敌状态闪烁效果
            if (gameState.player.invincible) {
                const visible = Math.floor(Date.now() / 100) % 2 === 0;
                player.style.opacity = visible ? '0.5' : '1';
            } else {
                player.style.opacity = '1';
            }
        }

        // 更新生命值显示
        function updateLivesDisplay() {
            livesContainer.innerHTML = '';
            for (let i = 0; i < gameState.player.lives; i++) {
                const lifeIcon = document.createElement('div');
                lifeIcon.className = 'life-icon';
                livesContainer.appendChild(lifeIcon);
            }
        }

        // 玩家射击
        function playerShoot() {
            const bulletCount = gameState.player.weapon === 'spread' ? 3 : 1;
            
            for (let i = 0; i < bulletCount; i++) {
                const bullet = {
                    x: gameState.player.direction === 'right' ? 
                        gameState.player.x + gameState.player.width : 
                        gameState.player.x - 8,
                    y: gameState.player.y + 10,
                    width: gameState.player.weapon === 'laser' ? 20 : 8,
                    height: 4,
                    speed: 10,
                    direction: gameState.player.direction,
                    type: gameState.player.weapon
                };
                
                // 散弹枪的子弹角度
                if (gameState.player.weapon === 'spread') {
                    bullet.speedY = i - 1; // 上中下三个角度
                }
                
                gameState.bullets.push(bullet);
                
                const bulletElement = document.createElement('div');
                bulletElement.className = 'bullet';
                bulletElement.style.left = `${bullet.x}px`;
                bulletElement.style.top = `${bullet.y}px`;
                bulletElement.style.width = `${bullet.width}px`;
                bulletElement.style.height = `${bullet.height}px`;
                
                // 激光武器颜色不同
                if (gameState.player.weapon === 'laser') {
                    bulletElement.style.backgroundColor = '#00ff00';
                }
                
                bulletElement.id = `bullet-${gameState.bullets.length - 1}`;
                gameContainer.appendChild(bulletElement);
            }
        }

        // 更新子弹位置
        function updateBullets() {
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                const bullet = gameState.bullets[i];
                
                // 移动子弹
                if (bullet.direction === 'right') {
                    bullet.x += bullet.speed;
                } else {
                    bullet.x -= bullet.speed;
                }
                
                // 散弹枪子弹的垂直移动
                if (bullet.speedY) {
                    bullet.y += bullet.speedY;
                }
                
                // 移除超出边界的子弹
                if (bullet.x < -20 || bullet.x > 820) {
                    removeBullet(i);
                    continue;
                }
                
                // 更新DOM元素
                const bulletElement = document.getElementById(`bullet-${i}`);
                if (bulletElement) {
                    bulletElement.style.left = `${bullet.x}px`;
                    bulletElement.style.top = `${bullet.y}px`;
                }
                
                // 检测子弹与敌人的碰撞
                checkBulletCollisions(i);
            }
        }

        // 移除子弹
        function removeBullet(index) {
            const bulletElement = document.getElementById(`bullet-${index}`);
            if (bulletElement) {
                bulletElement.remove();
            }
            gameState.bullets.splice(index, 1);
            
            // 更新后续子弹的ID
            for (let i = index; i < gameState.bullets.length; i++) {
                const bulletElement = document.getElementById(`bullet-${i + 1}`);
                if (bulletElement) {
                    bulletElement.id = `bullet-${i}`;
                }
            }
        }

        // 检测子弹碰撞
        function checkBulletCollisions(bulletIndex) {
            const bullet = gameState.bullets[bulletIndex];
            
            // 检测与敌人的碰撞
            for (let i = gameState.enemies.length - 1; i >= 0; i--) {
                const enemy = gameState.enemies[i];
                
                if (bullet.x < enemy.x + enemy.width &&
                    bullet.x + bullet.width > enemy.x &&
                    bullet.y < enemy.y + enemy.height &&
                    bullet.y + bullet.height > enemy.y) {
                    
                    // 击中敌人
                    enemy.health--;
                    
                    if (enemy.health <= 0) {
                        // 敌人被消灭
                        createExplosion(enemy.x, enemy.y);
                        gameState.score += 100;
                        scoreElement.textContent = gameState.score;
                        
                        // 移除敌人
                        const enemyElement = document.getElementById(`enemy-${i}`);
                        if (enemyElement) {
                            enemyElement.remove();
                        }
                        gameState.enemies.splice(i, 1);
                        
                        // 更新敌人数量
                        gameState.enemiesLeft--;
                        enemiesLeftElement.textContent = gameState.enemiesLeft;
                        
                        // 随机生成道具
                        if (Math.random() < 0.3) {
                            createPowerUp(enemy.x, enemy.y);
                        }
                    }
                    
                    // 移除子弹（激光除外）
                    if (bullet.type !== 'laser') {
                        removeBullet(bulletIndex);
                    }
                    
                    break;
                }
            }
            
            // 检测与Boss的碰撞
            if (gameState.boss) {
                const boss = gameState.boss;
                
                if (bullet.x < boss.x + boss.width &&
                    bullet.x + bullet.width > boss.x &&
                    bullet.y < boss.y + boss.height &&
                    bullet.y + bullet.height > boss.y) {
                    
                    // 击中Boss
                    boss.health--;
                    
                    createExplosion(bullet.x, bullet.y);
                    gameState.score += 50;
                    scoreElement.textContent = gameState.score;
                    
                    // 移除子弹（激光除外）
                    if (bullet.type !== 'laser') {
                        removeBullet(bulletIndex);
                    }
                    
                    // 检查Boss是否被击败
                    if (boss.health <= 0) {
                        createExplosion(boss.x, boss.y);
                        gameState.score += 1000;
                        scoreElement.textContent = gameState.score;
                        
                        const bossElement = document.getElementById('boss');
                        if (bossElement) {
                            bossElement.remove();
                        }
                        gameState.boss = null;
                        
                        // 更新敌人数量
                        gameState.enemiesLeft--;
                        enemiesLeftElement.textContent = gameState.enemiesLeft;
                        
                        // 生成升级道具
                        createPowerUp(boss.x, boss.y);
                    }
                    
                    return;
                }
            }
        }

        // 创建爆炸效果
        function createExplosion(x, y) {
            const explosion = {
                x: x - 20,
                y: y - 20,
                width: 40,
                height: 40,
                createdAt: Date.now()
            };
            
            gameState.explosions.push(explosion);
            
            const explosionElement = document.createElement('div');
            explosionElement.className = 'explosion';
            explosionElement.style.left = `${explosion.x}px`;
            explosionElement.style.top = `${explosion.y}px`;
            explosionElement.id = `explosion-${gameState.explosions.length - 1}`;
            gameContainer.appendChild(explosionElement);
            
            // 1秒后移除爆炸效果
            setTimeout(() => {
                explosionElement.remove();
            }, 500);
        }

        // 创建升级道具
        function createPowerUp(x, y) {
            const powerUp = {
                x: x,
                y: y,
                width: 20,
                height: 20,
                type: Math.random() > 0.5 ? 'weapon' : 'life'
            };
            
            gameState.powerUps.push(powerUp);
            
            const powerUpElement = document.createElement('div');
            powerUpElement.className = 'power-up';
            powerUpElement.style.left = `${powerUp.x}px`;
            powerUpElement.style.top = `${powerUp.y}px`;
            powerUpElement.id = `powerUp-${gameState.powerUps.length - 1}`;
            
            // 生命道具显示为红色
            if (powerUp.type === 'life') {
                powerUpElement.style.backgroundColor = '#ff0000';
            }
            
            gameContainer.appendChild(powerUpElement);
        }

        // 更新敌人位置
        function updateEnemies() {
            for (let i = 0; i < gameState.enemies.length; i++) {
                const enemy = gameState.enemies[i];
                
                // 移动敌人
                enemy.x += enemy.speedX * enemy.direction;
                
                // 碰到边界改变方向
                if (enemy.x <= 0 || enemy.x >= 770) {
                    enemy.direction *= -1;
                }
                
                // 更新DOM元素
                const enemyElement = document.getElementById(`enemy-${i}`);
                if (enemyElement) {
                    enemyElement.style.left = `${enemy.x}px`;
                    enemyElement.style.top = `${enemy.y}px`;
                }
                
                // 检测敌人与玩家的碰撞
                if (!gameState.player.invincible &&
                    enemy.x < gameState.player.x + gameState.player.width &&
                    enemy.x + enemy.width > gameState.player.x &&
                    enemy.y < gameState.player.y + gameState.player.height &&
                    enemy.y + enemy.height > gameState.player.y) {
                    
                    playerHit();
                }
            }
            
            // 更新Boss位置
            if (gameState.boss) {
                const boss = gameState.boss;
                
                // 移动Boss
                boss.x += boss.speedX * boss.direction;
                
                // 碰到边界改变方向
                if (boss.x <= 0 || boss.x >= 720) {
                    boss.direction *= -1;
                }
                
                // 更新DOM元素
                const bossElement = document.getElementById('boss');
                if (bossElement) {
                    bossElement.style.left = `${boss.x}px`;
                    bossElement.style.top = `${boss.y}px`;
                }
                
                // 检测Boss与玩家的碰撞
                if (!gameState.player.invincible &&
                    boss.x < gameState.player.x + gameState.player.width &&
                    boss.x + boss.width > gameState.player.x &&
                    boss.y < gameState.player.y + gameState.player.height &&
                    boss.y + boss.height > gameState.player.y) {
                    
                    playerHit();
                }
                
                // Boss偶尔发射子弹
                if (Math.random() < 0.02) {
                    bossShoot();
                }
            }
        }

        // Boss射击
        function bossShoot() {
            const bullet = {
                x: gameState.boss.x + gameState.boss.width / 2,
                y: gameState.boss.y + gameState.boss.height,
                width: 10,
                height: 10,
                speed: 3,
                direction: 'down'
            };
            
            const bulletElement = document.createElement('div');
            bulletElement.className = 'bullet';
            bulletElement.style.left = `${bullet.x}px`;
            bulletElement.style.top = `${bullet.y}px`;
            bulletElement.style.width = `${bullet.width}px`;
            bulletElement.style.height = `${bullet.height}px`;
            bulletElement.style.backgroundColor = '#ff00ff';
            bulletElement.id = `enemyBullet-${Date.now()}`;
            gameContainer.appendChild(bulletElement);
            
            // 添加敌人子弹到游戏状态
            if (!gameState.enemyBullets) gameState.enemyBullets = [];
            gameState.enemyBullets.push(bullet);
            
            // 移除超出边界的子弹
            setTimeout(() => {
                const bulletElement = document.getElementById(`enemyBullet-${Date.now()}`);
                if (bulletElement) {
                    bulletElement.remove();
                }
            }, 2000);
        }

        // 玩家被击中
        function playerHit() {
            gameState.player.lives--;
            updateLivesDisplay();
            
            if (gameState.player.lives <= 0) {
                gameOver();
                return;
            }
            
            // 进入无敌状态
            gameState.player.invincible = true;
            gameState.player.invincibleTimer = Date.now();
            
            // 重置玩家位置
            gameState.player.x = 100;
            gameState.player.y = 350;
            updatePlayerPosition();
            
            // 创建爆炸效果
            createExplosion(gameState.player.x, gameState.player.y);
        }

        // 更新道具
        function updatePowerUps() {
            for (let i = gameState.powerUps.length - 1; i >= 0; i--) {
                const powerUp = gameState.powerUps[i];
                
                // 检测与玩家的碰撞
                if (powerUp.x < gameState.player.x + gameState.player.width &&
                    powerUp.x + powerUp.width > gameState.player.x &&
                    powerUp.y < gameState.player.y + gameState.player.height &&
                    powerUp.y + powerUp.height > gameState.player.y) {
                    
                    // 获取道具
                    if (powerUp.type === 'weapon') {
                        // 武器升级
                        const weapons = ['basic', 'spread', 'laser'];
                        const currentIndex = weapons.indexOf(gameState.player.weapon);
                        const nextIndex = (currentIndex + 1) % weapons.length;
                        gameState.player.weapon = weapons[nextIndex];
                        gameState.player.weaponLevel = nextIndex + 1;
                        
                        weaponElement.textContent = 
                            gameState.player.weapon === 'basic' ? '基本枪' : 
                            gameState.player.weapon === 'spread' ? '散弹枪' : '激光枪';
                        
                        // 显示升级提示
                        showUpgradeIndicator('武器升级!');
                    } else if (powerUp.type === 'life') {
                        // 增加生命
                        gameState.player.lives = Math.min(gameState.player.lives + 1, 5);
                        updateLivesDisplay();
                        
                        // 显示升级提示
                        showUpgradeIndicator('生命+1!');
                    }
                    
                    // 移除道具
                    const powerUpElement = document.getElementById(`powerUp-${i}`);
                    if (powerUpElement) {
                        powerUpElement.remove();
                    }
                    gameState.powerUps.splice(i, 1);
                    
                    continue;
                }
                
                // 更新道具位置（下落）
                powerUp.y += 2;
                
                // 移除超出边界的道具
                if (powerUp.y > 500) {
                    const powerUpElement = document.getElementById(`powerUp-${i}`);
                    if (powerUpElement) {
                        powerUpElement.remove();
                    }
                    gameState.powerUps.splice(i, 1);
                    continue;
                }
                
                // 更新DOM元素
                const powerUpElement = document.getElementById(`powerUp-${i}`);
                if (powerUpElement) {
                    powerUpElement.style.top = `${powerUp.y}px`;
                }
            }
        }

        // 显示升级提示
        function showUpgradeIndicator(text) {
            const indicator = document.createElement('div');
            indicator.className = 'upgrade-indicator';
            indicator.textContent = text;
            indicator.style.left = `${gameState.player.x}px`;
            indicator.style.top = `${gameState.player.y - 20}px`;
            gameContainer.appendChild(indicator);
            
            // 2秒后移除提示
            setTimeout(() => {
                indicator.remove();
            }, 2000);
        }

        // 游戏结束
        function gameOver() {
            gameState.gameRunning = false;
            
            // 更新最高分
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('contraHighScore', gameState.highScore);
            }
            
            finalScoreElement.textContent = gameState.score;
            highScoreElement.textContent = gameState.highScore;
            gameOverScreen.classList.remove('hidden');
        }

        // 下一关
        function nextLevel() {
            gameState.level++;
            levelElement.textContent = gameState.level;
            
            // 增加玩家生命
            if (gameState.level % 2 === 0) {
                gameState.player.lives = Math.min(gameState.player.lives + 1, 5);
                updateLivesDisplay();
            }
            
            // 创建新敌人
            createEnemies();
            
            // 重置玩家位置
            gameState.player.x = 100;
            gameState.player.y = 350;
            updatePlayerPosition();
        }

        // 游戏循环
        function gameLoop() {
            if (!gameState.gameRunning) return;
            
            // 处理玩家移动
            if (gameState.keys['ArrowLeft'] || gameState.keys['KeyA']) {
                gameState.player.x = Math.max(0, gameState.player.x - gameState.player.speed);
                gameState.player.direction = 'left';
            }
            if (gameState.keys['ArrowRight'] || gameState.keys['KeyD']) {
                gameState.player.x = Math.min(770, gameState.player.x + gameState.player.speed);
                gameState.player.direction = 'right';
            }
            
            // 处理玩家跳跃
            if ((gameState.keys['ArrowUp'] || gameState.keys['KeyW'] || gameState.keys['KeyK']) && !gameState.player.isJumping) {
                gameState.player.isJumping = true;
                gameState.player.jumpCount = 15;
            }
            
            if (gameState.player.isJumping) {
                gameState.player.y -= gameState.player.jumpCount;
                gameState.player.jumpCount--;
                
                // 检测是否落地
                let onGround = false;
                for (const platform of gameState.platforms) {
                    if (gameState.player.y + gameState.player.height >= platform.y &&
                        gameState.player.y + gameState.player.height <= platform.y + 10 &&
                        gameState.player.x + gameState.player.width > platform.x &&
                        gameState.player.x < platform.x + platform.width) {
                        
                        gameState.player.y = platform.y - gameState.player.height;
                        gameState.player.isJumping = false;
                        onGround = true;
                        break;
                    }
                }
                
                // 如果没有落在平台上，检测是否落出屏幕
                if (!onGround && gameState.player.y > 500) {
                    playerHit();
                }
            } else {
                // 检测是否站在平台上
                let onPlatform = false;
                for (const platform of gameState.platforms) {
                    if (gameState.player.y + gameState.player.height >= platform.y &&
                        gameState.player.y + gameState.player.height <= platform.y + 5 &&
                        gameState.player.x + gameState.player.width > platform.x &&
                        gameState.player.x < platform.x + platform.width) {
                        
                        gameState.player.y = platform.y - gameState.player.height;
                        onPlatform = true;
                        break;
                    }
                }
                
                // 如果没有站在平台上，则下落
                if (!onPlatform) {
                    gameState.player.y += 5;
                }
            }
            
            // 处理射击
            if (gameState.keys['KeyJ'] && !gameState.keys['_shootCooldown']) {
                playerShoot();
                gameState.keys['_shootCooldown'] = true;
                
                // 射击冷却
                setTimeout(() => {
                    gameState.keys['_shootCooldown'] = false;
                }, gameState.player.weapon === 'laser' ? 100 : 300);
            }
            
            // 更新无敌状态
            if (gameState.player.invincible && Date.now() - gameState.player.invincibleTimer > 2000) {
                gameState.player.invincible = false;
            }
            
            // 更新所有游戏对象
            updatePlayerPosition();
            updateBullets();
            updateEnemies();
            updatePowerUps();
            
            // 检查是否进入下一关
            if (gameState.enemiesLeft <= 0) {
                nextLevel();
            }
            
            // 继续游戏循环
            requestAnimationFrame(gameLoop);
        }

        // 键盘事件监听
        document.addEventListener('keydown', (e) => {
            gameState.keys[e.code] = true;
            
            // 按Enter键开始/重新开始游戏
            if (e.code === 'Enter' && !gameState.gameRunning) {
                initGame();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            gameState.keys[e.code] = false;
        });

        // 重新开始按钮事件
        restartButton.addEventListener('click', initGame);

        // 初始化游戏
        initGame();
    </script>
</body>
</html>