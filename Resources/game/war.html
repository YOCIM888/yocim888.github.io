<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¢¦å¹»å¡”é˜²</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .game-container {
            width: 100%;
            max-width: 1200px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 8px solid #ff9a8b;
        }
        
        .game-header {
            background: linear-gradient(90deg, #ff9a8b 0%, #ff6a88 55%, #ff99ac 100%);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-title {
            font-size: 2.2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .game-title i {
            color: #ffeb3b;
            margin-right: 10px;
        }
        
        .game-stats {
            display: flex;
            gap: 25px;
            font-size: 1.3rem;
        }
        
        .stat {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat i {
            font-size: 1.5rem;
        }
        
        .game-content {
            display: flex;
            min-height: 600px;
        }
        
        .game-board {
            flex: 3;
            background-color: #e8f4f8;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .level-selector {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .level-btn {
            background-color: #ff9a8b;
            color: white;
            border: none;
            padding: 8px 20px;
            margin: 0 5px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .level-btn:hover {
            background-color: #ff7a6b;
            transform: translateY(-3px);
        }
        
        .level-btn.active {
            background-color: #ff5252;
            box-shadow: 0 5px 15px rgba(255, 82, 82, 0.4);
        }
        
        .game-map {
            position: relative;
            width: 100%;
            height: 400px;
            background-color: #b8e6d0;
            border-radius: 15px;
            overflow: hidden;
            border: 5px solid #a5d6c5;
            margin-bottom: 15px;
        }
        
        .path {
            position: absolute;
            background-color: #e6b8a8;
            border-radius: 10px;
        }
        
        .tower-spot {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            border: 2px dashed #ff9a8b;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .tower-spot:hover {
            background-color: rgba(255, 154, 139, 0.3);
            transform: scale(1.1);
        }
        
        .tower {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: white;
            z-index: 10;
            transition: transform 0.3s;
        }
        
        .tower:hover {
            transform: scale(1.2);
            z-index: 20;
        }
        
        .monster {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 5;
            transition: left 0.1s linear, top 0.1s linear;
        }
        
        .bullet {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 7;
        }
        
        .game-controls {
            flex: 1;
            background-color: #f9f9f9;
            padding: 25px;
            border-left: 3px dashed #ff9a8b;
        }
        
        .tower-shop {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #ff6a88;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffccd5;
        }
        
        .tower-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .tower-item {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.05);
        }
        
        .tower-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .tower-item.selected {
            border-color: #ff9a8b;
            background-color: #fff5f3;
        }
        
        .tower-icon {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }
        
        .tower-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .tower-cost {
            color: #ff6a88;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .tower-cost.free {
            color: #4CAF50;
        }
        
        .tower-stats {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .wave-info {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.05);
        }
        
        .wave-progress {
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .wave-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.5s;
        }
        
        .wave-text {
            text-align: center;
            font-size: 1.2rem;
            color: #ff6a88;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .monster-info {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.05);
        }
        
        .monster-list {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .monster-item {
            text-align: center;
        }
        
        .monster-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .monster-name {
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .game-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .btn-start {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-start:hover {
            background-color: #388E3C;
            transform: translateY(-3px);
        }
        
        .btn-pause {
            background-color: #FF9800;
            color: white;
        }
        
        .btn-pause:hover {
            background-color: #F57C00;
            transform: translateY(-3px);
        }
        
        .btn-restart {
            background-color: #9C27B0;
            color: white;
        }
        
        .btn-restart:hover {
            background-color: #7B1FA2;
            transform: translateY(-3px);
        }
        
        .game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }
        
        .message-title {
            font-size: 2.5rem;
            color: #ff6a88;
            margin-bottom: 15px;
        }
        
        .message-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #555;
        }
        
        .btn-close {
            background-color: #ff9a8b;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-close:hover {
            background-color: #ff7a6b;
            transform: translateY(-3px);
        }
        
        @media (max-width: 900px) {
            .game-content {
                flex-direction: column;
            }
            
            .game-controls {
                border-left: none;
                border-top: 3px dashed #ff9a8b;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">
                <i class="fas fa-carrot"></i> æ¢¦å¹»å¡”é˜²
            </div>
            <div class="game-stats">
                <div class="stat">
                    <i class="fas fa-coins" style="color: #FFD700;"></i>
                    <span id="gold">100</span>
                </div>
                <div class="stat">
                    <i class="fas fa-heart" style="color: #FF5252;"></i>
                    <span id="lives">20</span>
                </div>
                <div class="stat">
                    <i class="fas fa-flag" style="color: #4CAF50;"></i>
                    <span id="wave">0/10</span>
                </div>
            </div>
        </div>
        
        <div class="game-content">
            <div class="game-board">
                <div class="level-selector">
                    <button class="level-btn active" data-level="1">æ£®æ—å…³å¡</button>
                    <button class="level-btn" data-level="2">æ²™æ¼ å…³å¡</button>
                    <button class="level-btn" data-level="3">é›ªåœ°å…³å¡</button>
                </div>
                
                <div class="game-map" id="game-map">
                    <!-- æ¸¸æˆåœ°å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="game-buttons">
                    <button class="btn btn-start" id="start-wave">
                        <i class="fas fa-play"></i> å¼€å§‹æ³¢æ¬¡
                    </button>
                    <button class="btn btn-pause" id="pause-game">
                        <i class="fas fa-pause"></i> æš‚åœæ¸¸æˆ
                    </button>
                    <button class="btn btn-restart" id="restart-game">
                        <i class="fas fa-redo"></i> é‡æ–°å¼€å§‹
                    </button>
                </div>
            </div>
            
            <div class="game-controls">
                <div class="tower-shop">
                    <h3 class="section-title">é˜²å¾¡å¡”å•†åº—</h3>
                    <div class="tower-list" id="tower-list">
                        <!-- é˜²å¾¡å¡”åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="wave-info">
                    <h3 class="section-title">æ³¢æ¬¡ä¿¡æ¯</h3>
                    <div class="wave-text" id="wave-text">å‡†å¤‡å¼€å§‹æ¸¸æˆ</div>
                    <div class="wave-progress">
                        <div class="wave-progress-bar" id="wave-progress"></div>
                    </div>
                    <div id="next-wave-info">ä¸‹ä¸€æ³¢: 10ç§’å</div>
                </div>
                
                <div class="monster-info">
                    <h3 class="section-title">æ€ªç‰©å›¾é‰´</h3>
                    <div class="monster-list" id="monster-list">
                        <!-- æ€ªç‰©åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="game-message" id="game-message">
        <h2 class="message-title" id="message-title">æ¸¸æˆèƒœåˆ©!</h2>
        <p class="message-text" id="message-text">æ­å–œä½ æˆåŠŸé˜²å¾¡äº†æ‰€æœ‰æ€ªç‰©!</p>
        <button class="btn-close" id="close-message">ç»§ç»­æ¸¸æˆ</button>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            gold: 100,
            lives: 20,
            currentWave: 0,
            totalWaves: 10,
            isPaused: false,
            isGameOver: false,
            selectedTower: null,
            currentLevel: 1,
            towers: [],
            monsters: [],
            bullets: [],
            towerSpots: [],
            path: [],
            gameInterval: null,
            waveInterval: null,
            waveTimer: 0
        };

        // é˜²å¾¡å¡”æ•°æ®
        const towersData = [
            { id: 1, name: "èƒ¡èåœç‚®", icon: "ğŸ¥•", cost: 0, damage: 5, range: 120, speed: 1000, color: "#FF8A65", description: "å…è´¹ä½†æ”»å‡»åŠ›ä½" },
            { id: 2, name: "è¥¿ç“œæŠ•æ‰‹", icon: "ğŸ‰", cost: 30, damage: 15, range: 140, speed: 1500, color: "#4CAF50", description: "ä¸­ç­‰ä¼¤å®³ï¼ŒèŒƒå›´æ”»å‡»" },
            { id: 3, name: "å†°å†»è‰è“", icon: "ğŸ“", cost: 50, damage: 10, range: 130, speed: 2000, color: "#E91E63", description: "å‡ç¼“æ•Œäººé€Ÿåº¦" },
            { id: 4, name: "è èç‚¸å¼¹", icon: "ğŸ", cost: 80, damage: 40, range: 100, speed: 3000, color: "#FFC107", description: "é«˜ä¼¤å®³ï¼Œçˆ†ç‚¸èŒƒå›´" }
        ];

        // æ€ªç‰©æ•°æ®
        const monstersData = [
            { id: 1, name: "å°è˜‘è‡", icon: "ğŸ„", health: 20, speed: 1.5, gold: 5, color: "#FF6B6B" },
            { id: 2, name: "å—ç“œæ€ª", icon: "ğŸƒ", health: 40, speed: 1.0, gold: 10, color: "#FFA726" },
            { id: 3, name: "å¹½çµç³–", icon: "ğŸ‘»", health: 30, speed: 2.0, gold: 8, color: "#AB47BC" },
            { id: 4, name: "è›‹ç³•å·¨äºº", icon: "ğŸ°", health: 100, speed: 0.5, gold: 25, color: "#FF4081" }
        ];

        // å…³å¡åœ°å›¾æ•°æ®
        const levelsData = {
            1: {
                name: "æ£®æ—å…³å¡",
                backgroundColor: "#b8e6d0",
                pathColor: "#8BC34A",
                path: [
                    { x: 0, y: 150 },
                    { x: 200, y: 150 },
                    { x: 200, y: 300 },
                    { x: 400, y: 300 },
                    { x: 400, y: 100 },
                    { x: 600, y: 100 },
                    { x: 600, y: 250 },
                    { x: 800, y: 250 }
                ],
                towerSpots: [
                    { x: 100, y: 50 },
                    { x: 300, y: 200 },
                    { x: 150, y: 250 },
                    { x: 350, y: 50 },
                    { x: 500, y: 200 },
                    { x: 500, y: 50 },
                    { x: 650, y: 200 },
                    { x: 700, y: 100 }
                ]
            },
            2: {
                name: "æ²™æ¼ å…³å¡",
                backgroundColor: "#FFE082",
                pathColor: "#FFB74D",
                path: [
                    { x: 0, y: 100 },
                    { x: 150, y: 100 },
                    { x: 150, y: 250 },
                    { x: 350, y: 250 },
                    { x: 350, y: 100 },
                    { x: 550, y: 100 },
                    { x: 550, y: 300 },
                    { x: 750, y: 300 }
                ],
                towerSpots: [
                    { x: 50, y: 200 },
                    { x: 250, y: 50 },
                    { x: 250, y: 200 },
                    { x: 450, y: 200 },
                    { x: 400, y: 50 },
                    { x: 600, y: 200 },
                    { x: 700, y: 100 },
                    { x: 700, y: 250 }
                ]
            },
            3: {
                name: "é›ªåœ°å…³å¡",
                backgroundColor: "#B3E5FC",
                pathColor: "#4FC3F7",
                path: [
                    { x: 0, y: 200 },
                    { x: 100, y: 200 },
                    { x: 100, y: 100 },
                    { x: 300, y: 100 },
                    { x: 300, y: 250 },
                    { x: 500, y: 250 },
                    { x: 500, y: 150 },
                    { x: 700, y: 150 },
                    { x: 700, y: 300 },
                    { x: 800, y: 300 }
                ],
                towerSpots: [
                    { x: 200, y: 50 },
                    { x: 200, y: 200 },
                    { x: 400, y: 50 },
                    { x: 400, y: 200 },
                    { x: 600, y: 50 },
                    { x: 600, y: 200 },
                    { x: 750, y: 50 },
                    { x: 750, y: 250 }
                ]
            }
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.gold = 100;
            gameState.lives = 20;
            gameState.currentWave = 0;
            gameState.isPaused = false;
            gameState.isGameOver = false;
            gameState.selectedTower = null;
            gameState.towers = [];
            gameState.monsters = [];
            gameState.bullets = [];
            gameState.towerSpots = [];
            gameState.path = [];
            
            // æ¸…é™¤ä»»ä½•ç°æœ‰çš„æ¸¸æˆé—´éš”
            if (gameState.gameInterval) clearInterval(gameState.gameInterval);
            if (gameState.waveInterval) clearInterval(gameState.waveInterval);
            
            // æ›´æ–°UI
            updateUI();
            
            // åˆå§‹åŒ–å½“å‰å…³å¡
            loadLevel(gameState.currentLevel);
            
            // åˆå§‹åŒ–é˜²å¾¡å¡”å•†åº—
            initTowerShop();
            
            // åˆå§‹åŒ–æ€ªç‰©å›¾é‰´
            initMonsterInfo();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // æ˜¾ç¤ºå¼€å§‹æ¶ˆæ¯
            showMessage("æ¬¢è¿æ¥åˆ°æ¢¦å¹»å¡”é˜²", `é€‰æ‹©é˜²å¾¡å¡”æ”¾ç½®åœ¨ç©ºä½ä¸Šï¼Œç„¶åç‚¹å‡»"å¼€å§‹æ³¢æ¬¡"æŒ‰é’®ã€‚ç¬¬ä¸€åº§èƒ¡èåœç‚®æ˜¯å…è´¹çš„!`);
        }

        // åŠ è½½å…³å¡
        function loadLevel(level) {
            gameState.currentLevel = level;
            const levelData = levelsData[level];
            const gameMap = document.getElementById('game-map');
            
            // æ›´æ–°åœ°å›¾èƒŒæ™¯
            gameMap.style.backgroundColor = levelData.backgroundColor;
            
            // æ¸…é™¤åœ°å›¾å†…å®¹
            gameMap.innerHTML = '';
            
            // ç»˜åˆ¶è·¯å¾„
            drawPath(levelData.path, levelData.pathColor);
            
            // ä¿å­˜è·¯å¾„åˆ°æ¸¸æˆçŠ¶æ€
            gameState.path = levelData.path;
            
            // åˆ›å»ºé˜²å¾¡å¡”æ”¾ç½®ç‚¹
            createTowerSpots(levelData.towerSpots);
            
            // æ›´æ–°å…³å¡æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.level-btn').forEach(btn => {
                if (parseInt(btn.dataset.level) === level) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // æ›´æ–°æ³¢æ¬¡ä¿¡æ¯
            updateWaveInfo();
        }

        // ç»˜åˆ¶è·¯å¾„
        function drawPath(pathPoints, color) {
            const gameMap = document.getElementById('game-map');
            
            // ç»˜åˆ¶è·¯å¾„çº¿
            for (let i = 0; i < pathPoints.length - 1; i++) {
                const start = pathPoints[i];
                const end = pathPoints[i + 1];
                
                const pathSegment = document.createElement('div');
                pathSegment.className = 'path';
                
                // è®¡ç®—çº¿æ®µçš„é•¿åº¦å’Œè§’åº¦
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                // è®¾ç½®çº¿æ®µæ ·å¼
                pathSegment.style.width = `${length}px`;
                pathSegment.style.height = '30px';
                pathSegment.style.left = `${start.x}px`;
                pathSegment.style.top = `${start.y - 15}px`;
                pathSegment.style.transform = `rotate(${angle}deg)`;
                pathSegment.style.transformOrigin = '0 0';
                pathSegment.style.backgroundColor = color;
                
                gameMap.appendChild(pathSegment);
            }
            
            // ç»˜åˆ¶èµ·ç‚¹å’Œç»ˆç‚¹
            const startPoint = pathPoints[0];
            const endPoint = pathPoints[pathPoints.length - 1];
            
            const startMarker = document.createElement('div');
            startMarker.style.position = 'absolute';
            startMarker.style.left = `${startPoint.x - 15}px`;
            startMarker.style.top = `${startPoint.y - 15}px`;
            startMarker.style.width = '30px';
            startMarker.style.height = '30px';
            startMarker.style.borderRadius = '50%';
            startMarker.style.backgroundColor = '#4CAF50';
            startMarker.style.display = 'flex';
            startMarker.style.justifyContent = 'center';
            startMarker.style.alignItems = 'center';
            startMarker.style.color = 'white';
            startMarker.innerHTML = '<i class="fas fa-flag-checkered"></i>';
            gameMap.appendChild(startMarker);
            
            const endMarker = document.createElement('div');
            endMarker.style.position = 'absolute';
            endMarker.style.left = `${endPoint.x - 15}px`;
            endMarker.style.top = `${endPoint.y - 15}px`;
            endMarker.style.width = '30px';
            endMarker.style.height = '30px';
            endMarker.style.borderRadius = '50%';
            endMarker.style.backgroundColor = '#FF5252';
            endMarker.style.display = 'flex';
            endMarker.style.justifyContent = 'center';
            endMarker.style.alignItems = 'center';
            endMarker.style.color = 'white';
            endMarker.innerHTML = '<i class="fas fa-home"></i>';
            gameMap.appendChild(endMarker);
        }

        // åˆ›å»ºé˜²å¾¡å¡”æ”¾ç½®ç‚¹
        function createTowerSpots(spots) {
            const gameMap = document.getElementById('game-map');
            gameState.towerSpots = [];
            
            spots.forEach(spot => {
                const towerSpot = document.createElement('div');
                towerSpot.className = 'tower-spot';
                towerSpot.style.left = `${spot.x - 25}px`;
                towerSpot.style.top = `${spot.y - 25}px`;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                towerSpot.addEventListener('click', () => placeTower(spot));
                
                gameMap.appendChild(towerSpot);
                gameState.towerSpots.push({ element: towerSpot, x: spot.x, y: spot.y, occupied: false });
            });
        }

        // åˆå§‹åŒ–é˜²å¾¡å¡”å•†åº—
        function initTowerShop() {
            const towerList = document.getElementById('tower-list');
            towerList.innerHTML = '';
            
            towersData.forEach(tower => {
                const towerItem = document.createElement('div');
                towerItem.className = 'tower-item';
                towerItem.dataset.towerId = tower.id;
                
                const costClass = tower.cost === 0 ? 'free' : '';
                
                towerItem.innerHTML = `
                    <div class="tower-icon">${tower.icon}</div>
                    <div class="tower-name">${tower.name}</div>
                    <div class="tower-cost ${costClass}">${tower.cost === 0 ? 'å…è´¹' : tower.cost + 'é‡‘å¸'}</div>
                    <div class="tower-stats">ä¼¤å®³: ${tower.damage} | èŒƒå›´: ${tower.range}px</div>
                    <div class="tower-stats">${tower.description}</div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                towerItem.addEventListener('click', () => selectTower(tower.id));
                
                towerList.appendChild(towerItem);
            });
        }

        // åˆå§‹åŒ–æ€ªç‰©å›¾é‰´
        function initMonsterInfo() {
            const monsterList = document.getElementById('monster-list');
            monsterList.innerHTML = '';
            
            monstersData.forEach(monster => {
                const monsterItem = document.createElement('div');
                monsterItem.className = 'monster-item';
                
                monsterItem.innerHTML = `
                    <div class="monster-icon">${monster.icon}</div>
                    <div class="monster-name">${monster.name}</div>
                    <div class="tower-stats">ç”Ÿå‘½: ${monster.health}</div>
                    <div class="tower-stats">é‡‘å¸: ${monster.gold}</div>
                `;
                
                monsterList.appendChild(monsterItem);
            });
        }

        // é€‰æ‹©é˜²å¾¡å¡”
        function selectTower(towerId) {
            // å¦‚æœå·²ç»é€‰æ‹©äº†è¿™ä¸ªé˜²å¾¡å¡”ï¼Œå–æ¶ˆé€‰æ‹©
            if (gameState.selectedTower === towerId) {
                gameState.selectedTower = null;
                document.querySelectorAll('.tower-item').forEach(item => {
                    item.classList.remove('selected');
                });
                return;
            }
            
            // é€‰æ‹©æ–°çš„é˜²å¾¡å¡”
            gameState.selectedTower = towerId;
            
            // æ›´æ–°UI
            document.querySelectorAll('.tower-item').forEach(item => {
                if (parseInt(item.dataset.towerId) === towerId) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // æ”¾ç½®é˜²å¾¡å¡”
        function placeTower(spot) {
            if (!gameState.selectedTower) {
                showMessage("è¯·é€‰æ‹©é˜²å¾¡å¡”", "è¯·å…ˆä»å³ä¾§å•†åº—é€‰æ‹©ä¸€ç§é˜²å¾¡å¡”ã€‚");
                return;
            }
            
            // æ£€æŸ¥è¿™ä¸ªä½ç½®æ˜¯å¦å·²ç»è¢«å ç”¨
            const towerSpot = gameState.towerSpots.find(s => 
                Math.abs(s.x - spot.x) < 5 && Math.abs(s.y - spot.y) < 5
            );
            
            if (towerSpot && towerSpot.occupied) {
                showMessage("ä½ç½®å·²è¢«å ç”¨", "è¿™ä¸ªä½ç½®å·²ç»æœ‰ä¸€åº§é˜²å¾¡å¡”äº†ï¼Œè¯·é€‰æ‹©å…¶ä»–ä½ç½®ã€‚");
                return;
            }
            
            // è·å–é˜²å¾¡å¡”æ•°æ®
            const towerData = towersData.find(t => t.id === gameState.selectedTower);
            
            // æ£€æŸ¥é‡‘å¸æ˜¯å¦è¶³å¤Ÿ
            if (gameState.gold < towerData.cost) {
                showMessage("é‡‘å¸ä¸è¶³", `ä½ éœ€è¦${towerData.cost}é‡‘å¸æ¥å»ºé€ ${towerData.name}ï¼Œä½†ä½ ç°åœ¨åªæœ‰${gameState.gold}é‡‘å¸ã€‚`);
                return;
            }
            
            // æ‰£é™¤é‡‘å¸
            if (towerData.cost > 0) {
                gameState.gold -= towerData.cost;
                updateUI();
            }
            
            // åˆ›å»ºé˜²å¾¡å¡”
            const tower = {
                id: gameState.towers.length + 1,
                type: towerData.id,
                x: spot.x,
                y: spot.y,
                damage: towerData.damage,
                range: towerData.range,
                speed: towerData.speed,
                color: towerData.color,
                icon: towerData.icon,
                lastShot: Date.now()
            };
            
            // æ·»åŠ åˆ°æ¸¸æˆçŠ¶æ€
            gameState.towers.push(tower);
            
            // æ ‡è®°ä½ç½®ä¸ºå·²å ç”¨
            if (towerSpot) {
                towerSpot.occupied = true;
                towerSpot.element.style.display = 'none';
            }
            
            // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé˜²å¾¡å¡”
            const gameMap = document.getElementById('game-map');
            const towerElement = document.createElement('div');
            towerElement.className = 'tower';
            towerElement.id = `tower-${tower.id}`;
            towerElement.style.left = `${spot.x - 20}px`;
            towerElement.style.top = `${spot.y - 20}px`;
            towerElement.style.backgroundColor = tower.color;
            towerElement.innerHTML = tower.icon;
            gameMap.appendChild(towerElement);
            
            // å–æ¶ˆé€‰æ‹©é˜²å¾¡å¡”
            gameState.selectedTower = null;
            document.querySelectorAll('.tower-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // å¼€å§‹æ³¢æ¬¡
        function startWave() {
            if (gameState.currentWave >= gameState.totalWaves) {
                showMessage("æ¸¸æˆèƒœåˆ©!", "æ­å–œä½ æˆåŠŸé˜²å¾¡äº†æ‰€æœ‰æ€ªç‰©!");
                return;
            }
            
            // æ›´æ–°æ³¢æ¬¡
            gameState.currentWave++;
            updateWaveInfo();
            
            // ç”Ÿæˆæ€ªç‰©
            generateMonstersForWave();
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            if (!gameState.gameInterval) {
                gameState.gameInterval = setInterval(gameLoop, 50);
            }
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.getElementById('start-wave').innerHTML = '<i class="fas fa-forward"></i> ä¸‹ä¸€æ³¢';
            
            // ç¦ç”¨å¼€å§‹æŒ‰é’®ç›´åˆ°å½“å‰æ³¢æ¬¡ç»“æŸ
            document.getElementById('start-wave').disabled = true;
        }

        // ä¸ºå½“å‰æ³¢æ¬¡ç”Ÿæˆæ€ªç‰©
        function generateMonstersForWave() {
            // æ ¹æ®æ³¢æ¬¡å†³å®šæ€ªç‰©æ•°é‡å’Œç±»å‹
            const baseCount = 5;
            const waveMultiplier = Math.floor(gameState.currentWave / 3) + 1;
            const monsterCount = baseCount + waveMultiplier * 2;
            
            // ç¡®å®šæ€ªç‰©ç±»å‹ï¼ˆéšç€æ³¢æ¬¡å¢åŠ ï¼Œå‡ºç°æ›´å¼ºçš„æ€ªç‰©ï¼‰
            let monsterTypes = [1]; // ç¬¬ä¸€æ³¢åªæœ‰å°è˜‘è‡
            
            if (gameState.currentWave >= 3) monsterTypes.push(2); // ç¬¬ä¸‰æ³¢åŠ å…¥å—ç“œæ€ª
            if (gameState.currentWave >= 5) monsterTypes.push(3); // ç¬¬äº”æ³¢åŠ å…¥å¹½çµç³–
            if (gameState.currentWave >= 8) monsterTypes.push(4); // ç¬¬å…«æ³¢åŠ å…¥è›‹ç³•å·¨äºº
            
            // ç”Ÿæˆæ€ªç‰©
            for (let i = 0; i < monsterCount; i++) {
                // éšæœºé€‰æ‹©æ€ªç‰©ç±»å‹
                const monsterType = monsterTypes[Math.floor(Math.random() * monsterTypes.length)];
                const monsterData = monstersData.find(m => m.id === monsterType);
                
                // å¢åŠ åæœŸæ³¢æ¬¡çš„æ€ªç‰©è¡€é‡
                const healthMultiplier = 1 + (gameState.currentWave - 1) * 0.2;
                const monsterHealth = Math.floor(monsterData.health * healthMultiplier);
                
                const monster = {
                    id: gameState.monsters.length + 1,
                    type: monsterType,
                    health: monsterHealth,
                    maxHealth: monsterHealth,
                    speed: monsterData.speed,
                    gold: monsterData.gold,
                    color: monsterData.color,
                    icon: monsterData.icon,
                    pathIndex: 0,
                    x: gameState.path[0].x,
                    y: gameState.path[0].y,
                    progress: 0
                };
                
                gameState.monsters.push(monster);
                
                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæ€ªç‰©
                const gameMap = document.getElementById('game-map');
                const monsterElement = document.createElement('div');
                monsterElement.className = 'monster';
                monsterElement.id = `monster-${monster.id}`;
                monsterElement.style.left = `${monster.x - 20}px`;
                monsterElement.style.top = `${monster.y - 20}px`;
                monsterElement.style.backgroundColor = monster.color;
                monsterElement.innerHTML = monster.icon;
                gameMap.appendChild(monsterElement);
                
                // æ·»åŠ è¡€æ¡
                const healthBar = document.createElement('div');
                healthBar.style.position = 'absolute';
                healthBar.style.width = '40px';
                healthBar.style.height = '5px';
                healthBar.style.backgroundColor = '#FF5252';
                healthBar.style.bottom = '-8px';
                healthBar.style.left = '0';
                healthBar.style.borderRadius = '2px';
                healthBar.style.overflow = 'hidden';
                
                const healthFill = document.createElement('div');
                healthFill.id = `monster-health-${monster.id}`;
                healthFill.style.width = '100%';
                healthFill.style.height = '100%';
                healthFill.style.backgroundColor = '#4CAF50';
                healthFill.style.transition = 'width 0.3s';
                
                healthBar.appendChild(healthFill);
                monsterElement.appendChild(healthBar);
            }
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (gameState.isPaused || gameState.isGameOver) return;
            
            // ç§»åŠ¨æ€ªç‰©
            moveMonsters();
            
            // é˜²å¾¡å¡”æ”»å‡»
            towersAttack();
            
            // ç§»åŠ¨å­å¼¹
            moveBullets();
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (gameState.lives <= 0) {
                gameOver();
                return;
            }
            
            // æ£€æŸ¥æ³¢æ¬¡æ˜¯å¦ç»“æŸ
            if (gameState.monsters.length === 0 && gameState.currentWave > 0) {
                waveComplete();
            }
        }

        // ç§»åŠ¨æ€ªç‰©
        function moveMonsters() {
            gameState.monsters.forEach(monster => {
                // è·å–å½“å‰è·¯å¾„æ®µ
                if (monster.pathIndex >= gameState.path.length - 1) {
                    // æ€ªç‰©åˆ°è¾¾ç»ˆç‚¹
                    gameState.lives--;
                    updateUI();
                    removeMonster(monster.id);
                    return;
                }
                
                const startPoint = gameState.path[monster.pathIndex];
                const endPoint = gameState.path[monster.pathIndex + 1];
                
                // è®¡ç®—ç§»åŠ¨æ–¹å‘
                const dx = endPoint.x - startPoint.x;
                const dy = endPoint.y - startPoint.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // æ›´æ–°è¿›åº¦
                monster.progress += monster.speed / distance;
                
                // å¦‚æœåˆ°è¾¾å½“å‰è·¯å¾„æ®µçš„ç»ˆç‚¹ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€æ®µ
                if (monster.progress >= 1) {
                    monster.pathIndex++;
                    monster.progress = 0;
                    
                    // å¦‚æœåˆ°è¾¾ç»ˆç‚¹
                    if (monster.pathIndex >= gameState.path.length - 1) {
                        monster.x = endPoint.x;
                        monster.y = endPoint.y;
                    }
                } else {
                    // è®¡ç®—å½“å‰ä½ç½®
                    monster.x = startPoint.x + dx * monster.progress;
                    monster.y = startPoint.y + dy * monster.progress;
                }
                
                // æ›´æ–°æ€ªç‰©ä½ç½®
                const monsterElement = document.getElementById(`monster-${monster.id}`);
                if (monsterElement) {
                    monsterElement.style.left = `${monster.x - 20}px`;
                    monsterElement.style.top = `${monster.y - 20}px`;
                }
            });
        }

        // é˜²å¾¡å¡”æ”»å‡»
        function towersAttack() {
            const now = Date.now();
            
            gameState.towers.forEach(tower => {
                // æ£€æŸ¥å†·å´æ—¶é—´
                if (now - tower.lastShot < tower.speed) return;
                
                // å¯»æ‰¾ç›®æ ‡
                const target = findTarget(tower);
                
                if (target) {
                    // å‘å°„å­å¼¹
                    shootBullet(tower, target);
                    tower.lastShot = now;
                }
            });
        }

        // å¯»æ‰¾ç›®æ ‡
        function findTarget(tower) {
            let target = null;
            let closestDistance = tower.range;
            
            gameState.monsters.forEach(monster => {
                const dx = monster.x - tower.x;
                const dy = monster.y - tower.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    target = monster;
                }
            });
            
            return target;
        }

        // å‘å°„å­å¼¹
        function shootBullet(tower, target) {
            const bullet = {
                id: gameState.bullets.length + 1,
                towerId: tower.id,
                targetId: target.id,
                x: tower.x,
                y: tower.y,
                damage: tower.damage,
                color: tower.color,
                speed: 5
            };
            
            gameState.bullets.push(bullet);
            
            // åˆ›å»ºå­å¼¹å…ƒç´ 
            const gameMap = document.getElementById('game-map');
            const bulletElement = document.createElement('div');
            bulletElement.className = 'bullet';
            bulletElement.id = `bullet-${bullet.id}`;
            bulletElement.style.left = `${bullet.x - 5}px`;
            bulletElement.style.top = `${bullet.y - 5}px`;
            bulletElement.style.backgroundColor = bullet.color;
            gameMap.appendChild(bulletElement);
        }

        // ç§»åŠ¨å­å¼¹
        function moveBullets() {
            gameState.bullets.forEach(bullet => {
                // è·å–ç›®æ ‡
                const target = gameState.monsters.find(m => m.id === bullet.targetId);
                
                if (!target) {
                    // ç›®æ ‡å·²ä¸å­˜åœ¨ï¼Œç§»é™¤å­å¼¹
                    removeBullet(bullet.id);
                    return;
                }
                
                // è®¡ç®—å­å¼¹æ–¹å‘
                const dx = target.x - bullet.x;
                const dy = target.y - bullet.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // å¦‚æœå­å¼¹åˆ°è¾¾ç›®æ ‡
                if (distance < 10) {
                    // é€ æˆä¼¤å®³
                    dealDamage(target.id, bullet.damage);
                    // ç§»é™¤å­å¼¹
                    removeBullet(bullet.id);
                    return;
                }
                
                // ç§»åŠ¨å­å¼¹
                bullet.x += (dx / distance) * bullet.speed;
                bullet.y += (dy / distance) * bullet.speed;
                
                // æ›´æ–°å­å¼¹ä½ç½®
                const bulletElement = document.getElementById(`bullet-${bullet.id}`);
                if (bulletElement) {
                    bulletElement.style.left = `${bullet.x - 5}px`;
                    bulletElement.style.top = `${bullet.y - 5}px`;
                }
            });
        }

        // é€ æˆä¼¤å®³
        function dealDamage(monsterId, damage) {
            const monster = gameState.monsters.find(m => m.id === monsterId);
            if (!monster) return;
            
            monster.health -= damage;
            
            // æ›´æ–°è¡€æ¡
            const healthFill = document.getElementById(`monster-health-${monsterId}`);
            if (healthFill) {
                const healthPercent = (monster.health / monster.maxHealth) * 100;
                healthFill.style.width = `${healthPercent}%`;
            }
            
            // å¦‚æœæ€ªç‰©æ­»äº¡
            if (monster.health <= 0) {
                // å¥–åŠ±é‡‘å¸
                gameState.gold += monster.gold;
                updateUI();
                // ç§»é™¤æ€ªç‰©
                removeMonster(monsterId);
            }
        }

        // ç§»é™¤æ€ªç‰©
        function removeMonster(monsterId) {
            // ä»é¡µé¢ç§»é™¤
            const monsterElement = document.getElementById(`monster-${monsterId}`);
            if (monsterElement) {
                monsterElement.remove();
            }
            
            // ä»æ¸¸æˆçŠ¶æ€ç§»é™¤
            gameState.monsters = gameState.monsters.filter(m => m.id !== monsterId);
        }

        // ç§»é™¤å­å¼¹
        function removeBullet(bulletId) {
            // ä»é¡µé¢ç§»é™¤
            const bulletElement = document.getElementById(`bullet-${bulletId}`);
            if (bulletElement) {
                bulletElement.remove();
            }
            
            // ä»æ¸¸æˆçŠ¶æ€ç§»é™¤
            gameState.bullets = gameState.bullets.filter(b => b.id !== bulletId);
        }

        // æ³¢æ¬¡å®Œæˆ
        function waveComplete() {
            // å¯ç”¨å¼€å§‹æŒ‰é’®
            document.getElementById('start-wave').disabled = false;
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            if (gameState.currentWave >= gameState.totalWaves) {
                showMessage("æ¸¸æˆèƒœåˆ©!", "æ­å–œä½ æˆåŠŸé˜²å¾¡äº†æ‰€æœ‰æ€ªç‰©!");
            } else {
                showMessage(`æ³¢æ¬¡ ${gameState.currentWave} å®Œæˆ!`, `ä½ æˆåŠŸé˜²å¾¡äº†ç¬¬ ${gameState.currentWave} æ³¢æ€ªç‰©ã€‚å‡†å¤‡è¿æ¥ä¸‹ä¸€æ³¢!`);
            }
            
            // æ›´æ–°æ³¢æ¬¡ä¿¡æ¯
            updateWaveInfo();
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameState.isGameOver = true;
            clearInterval(gameState.gameInterval);
            gameState.gameInterval = null;
            
            showMessage("æ¸¸æˆç»“æŸ", `ä½ æˆåŠŸé˜²å¾¡äº† ${gameState.currentWave} æ³¢æ€ªç‰©ã€‚ç‚¹å‡»é‡æ–°å¼€å§‹æŒ‰é’®å†è¯•ä¸€æ¬¡!`);
        }

        // æ›´æ–°UI
        function updateUI() {
            document.getElementById('gold').textContent = gameState.gold;
            document.getElementById('lives').textContent = gameState.lives;
            document.getElementById('wave').textContent = `${gameState.currentWave}/${gameState.totalWaves}`;
            
            // æ›´æ–°æ³¢æ¬¡è¿›åº¦æ¡
            const progressPercent = (gameState.currentWave / gameState.totalWaves) * 100;
            document.getElementById('wave-progress').style.width = `${progressPercent}%`;
            
            // æ›´æ–°æ³¢æ¬¡æ–‡æœ¬
            const waveText = document.getElementById('wave-text');
            if (gameState.currentWave === 0) {
                waveText.textContent = "å‡†å¤‡å¼€å§‹æ¸¸æˆ";
            } else if (gameState.currentWave < gameState.totalWaves) {
                waveText.textContent = `æ³¢æ¬¡ ${gameState.currentWave}/${gameState.totalWaves}`;
            } else {
                waveText.textContent = "æœ€ç»ˆæ³¢æ¬¡!";
            }
        }

        // æ›´æ–°æ³¢æ¬¡ä¿¡æ¯
        function updateWaveInfo() {
            const nextWaveInfo = document.getElementById('next-wave-info');
            
            if (gameState.currentWave === 0) {
                nextWaveInfo.textContent = "ç‚¹å‡»å¼€å§‹æ³¢æ¬¡æŒ‰é’®å¼€å§‹æ¸¸æˆ";
            } else if (gameState.currentWave < gameState.totalWaves) {
                nextWaveInfo.textContent = `ä¸‹ä¸€æ³¢: æ€ªç‰©æ›´å¼ºæ›´å¤š`;
            } else {
                nextWaveInfo.textContent = "è¿™æ˜¯æœ€åä¸€æ³¢äº†!";
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(title, text) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = text;
            document.getElementById('game-message').style.display = 'block';
        }

        // éšè—æ¶ˆæ¯
        function hideMessage() {
            document.getElementById('game-message').style.display = 'none';
        }

        // æš‚åœæ¸¸æˆ
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            const pauseBtn = document.getElementById('pause-game');
            
            if (gameState.isPaused) {
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­æ¸¸æˆ';
                pauseBtn.classList.remove('btn-pause');
                pauseBtn.classList.add('btn-start');
            } else {
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœæ¸¸æˆ';
                pauseBtn.classList.remove('btn-start');
                pauseBtn.classList.add('btn-pause');
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å¼€å§‹æ³¢æ¬¡æŒ‰é’®
            document.getElementById('start-wave').addEventListener('click', startWave);
            
            // æš‚åœæ¸¸æˆæŒ‰é’®
            document.getElementById('pause-game').addEventListener('click', togglePause);
            
            // é‡æ–°å¼€å§‹æŒ‰é’®
            document.getElementById('restart-game').addEventListener('click', initGame);
            
            // å…³é—­æ¶ˆæ¯æŒ‰é’®
            document.getElementById('close-message').addEventListener('click', hideMessage);
            
            // å…³å¡é€‰æ‹©æŒ‰é’®
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const level = parseInt(btn.dataset.level);
                    loadLevel(level);
                });
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        window.onload = initGame;
    </script>
</body>
</html>