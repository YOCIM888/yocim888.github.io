<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»æœ›é˜²çº¿ - æ¤ç‰©å¤§æˆ˜åƒµå°¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(to bottom, #0a3d62, #1e5799);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 3px solid #f6b93b;
            box-shadow: 0 0 20px rgba(246, 185, 59, 0.5);
        }
        
        h1 {
            color: #f6b93b;
            font-size: 3.5rem;
            text-shadow: 3px 3px 0 #e55039, 6px 6px 0 rgba(0, 0, 0, 0.5);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #78e08f;
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #4a69bd;
        }
        
        .sun-counter {
            display: flex;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            color: #f6b93b;
        }
        
        .sun-icon {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #f6b93b, #e58e26);
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 10px #f6b93b;
            position: relative;
        }
        
        .sun-icon::after {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: radial-gradient(circle at 30% 30%, rgba(246, 185, 59, 0.4), transparent 70%);
            border-radius: 50%;
        }
        
        .level-info {
            text-align: center;
        }
        
        .level {
            font-size: 1.8rem;
            color: #78e08f;
            margin-bottom: 5px;
        }
        
        .wave-indicator {
            height: 10px;
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 0 auto;
        }
        
        .wave-progress {
            height: 100%;
            width: 30%;
            background: linear-gradient(to right, #4a69bd, #6a89cc);
            border-radius: 5px;
            transition: width 0.5s;
        }
        
        .game-area {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .lawn {
            flex: 3;
            background: rgba(46, 134, 68, 0.8);
            border: 5px solid #5a3921;
            border-radius: 10px;
            padding: 10px;
            position: relative;
            min-height: 600px;
            overflow: hidden;
        }
        
        .lawn-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 5px;
            height: 100%;
        }
        
        .lawn-cell {
            background: rgba(120, 224, 143, 0.3);
            border: 1px solid rgba(46, 204, 113, 0.5);
            border-radius: 5px;
            position: relative;
            min-height: 100px;
        }
        
        .lawn-cell.highlight {
            background: rgba(246, 185, 59, 0.5);
            border-color: #f6b93b;
        }
        
        .plants-panel {
            flex: 1;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #78e08f;
            min-width: 200px;
        }
        
        .plants-panel h2 {
            color: #78e08f;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4a69bd;
        }
        
        .plant-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .plant-option {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .plant-option:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .plant-option.selected {
            border-color: #f6b93b;
            background: rgba(246, 185, 59, 0.2);
        }
        
        .plant-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .plant-cost {
            display: flex;
            align-items: center;
            color: #f6b93b;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .plant-name {
            margin-top: 5px;
            font-weight: bold;
            color: #fff;
        }
        
        .plant-desc {
            font-size: 0.8rem;
            color: #ccc;
            text-align: center;
            margin-top: 5px;
        }
        
        .plant-sunflower .plant-icon {
            background: radial-gradient(circle at 30% 30%, #f6b93b, #e58e26);
        }
        
        .plant-peashooter .plant-icon {
            background: radial-gradient(circle at 30% 30%, #78e08f, #38ada9);
        }
        
        .plant-wallnut .plant-icon {
            background: radial-gradient(circle at 30% 30%, #8B4513, #A0522D);
        }
        
        .plant-cherrybomb .plant-icon {
            background: radial-gradient(circle at 30% 30%, #e55039, #b71540);
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        button {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #startBtn {
            background: linear-gradient(to bottom, #78e08f, #38ada9);
            color: #fff;
        }
        
        #startBtn:hover {
            background: linear-gradient(to bottom, #38ada9, #78e08f);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(56, 173, 169, 0.4);
        }
        
        #restartBtn {
            background: linear-gradient(to bottom, #f6b93b, #e58e26);
            color: #fff;
        }
        
        #restartBtn:hover {
            background: linear-gradient(to bottom, #e58e26, #f6b93b);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(229, 142, 38, 0.4);
        }
        
        .plant {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            z-index: 10;
            transition: transform 0.2s;
            user-select: none;
        }
        
        .zombie {
            position: absolute;
            width: 70px;
            height: 90px;
            right: -100px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            z-index: 5;
            transition: left 0.5s linear;
        }
        
        .projectile {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            z-index: 8;
        }
        
        .sun {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #f6b93b, #e58e26);
            z-index: 7;
            cursor: pointer;
            animation: float 5s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            border: 5px solid #f6b93b;
            display: none;
            max-width: 500px;
            width: 90%;
        }
        
        .message h2 {
            color: #f6b93b;
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .message p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .message button {
            padding: 15px 40px;
            font-size: 1.3rem;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #78e08f;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 1100px) {
            .game-area {
                flex-direction: column;
            }
            
            .plants-panel {
                min-width: 100%;
            }
            
            .lawn-grid {
                grid-template-columns: repeat(9, 1fr);
                grid-template-rows: repeat(5, 80px);
            }
        }
        
        @media (max-width: 768px) {
            .lawn-grid {
                grid-template-columns: repeat(5, 1fr);
                grid-template-rows: repeat(9, 80px);
            }
            
            h1 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ç»æœ›é˜²çº¿</h1>
            <p class="subtitle">æ¤ç‰©å¤§æˆ˜åƒµå°¸é˜²å¾¡æˆ˜ - ä¿æŠ¤ä½ çš„è‰åªï¼Œé˜»æ­¢åƒµå°¸å…¥ä¾µï¼</p>
        </header>
        
        <div class="game-stats">
            <div class="sun-counter">
                <div class="sun-icon"></div>
                <span id="sunCount">150</span>
            </div>
            
            <div class="level-info">
                <div class="level">ç¬¬ <span id="currentLevel">1</span> å…³</div>
                <div class="wave-indicator">
                    <div class="wave-progress" id="waveProgress"></div>
                </div>
                <div>åƒµå°¸æ³¢æ¬¡: <span id="waveCount">1/5</span></div>
            </div>
            
            <div class="zombies-remaining">
                å‰©ä½™åƒµå°¸: <span id="zombiesLeft">10</span>
            </div>
        </div>
        
        <div class="game-area">
            <div class="lawn" id="lawn">
                <div class="lawn-grid" id="lawnGrid">
                    <!-- æ¸¸æˆç½‘æ ¼å°†é€šè¿‡JSç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="plants-panel">
                <h2>æ¤ç‰©é€‰æ‹©</h2>
                <div class="plant-options">
                    <div class="plant-option plant-sunflower selected" data-plant="sunflower">
                        <div class="plant-icon">ğŸŒ»</div>
                        <div class="plant-cost">é˜³å…‰: <span>50</span></div>
                        <div class="plant-name">å‘æ—¥è‘µ</div>
                        <div class="plant-desc">ç”Ÿäº§æ›´å¤šé˜³å…‰</div>
                    </div>
                    
                    <div class="plant-option plant-peashooter" data-plant="peashooter">
                        <div class="plant-icon">ğŸŒ±</div>
                        <div class="plant-cost">é˜³å…‰: <span>100</span></div>
                        <div class="plant-name">è±Œè±†å°„æ‰‹</div>
                        <div class="plant-desc">å‘å°„è±Œè±†æ”»å‡»åƒµå°¸</div>
                    </div>
                    
                    <div class="plant-option plant-wallnut" data-plant="wallnut">
                        <div class="plant-icon">ğŸŒ°</div>
                        <div class="plant-cost">é˜³å…‰: <span>50</span></div>
                        <div class="plant-name">åšæœå¢™</div>
                        <div class="plant-desc">é«˜è€ä¹…é˜²å¾¡å•ä½</div>
                    </div>
                    
                    <div class="plant-option plant-cherrybomb" data-plant="cherrybomb">
                        <div class="plant-icon">ğŸ’£</div>
                        <div class="plant-cost">é˜³å…‰: <span>150</span></div>
                        <div class="plant-name">æ¨±æ¡ƒç‚¸å¼¹</div>
                        <div class="plant-desc">çˆ†ç‚¸æ¶ˆç­å‘¨å›´åƒµå°¸</div>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3>æ¸¸æˆè¯´æ˜</h3>
                    <p>1. é€‰æ‹©æ¤ç‰©ï¼Œç‚¹å‡»è‰åªæ”¾ç½®</p>
                    <p>2. æ”¶é›†é˜³å…‰è´­ä¹°æ¤ç‰©</p>
                    <p>3. é˜»æ­¢åƒµå°¸åˆ°è¾¾å·¦ä¾§</p>
                    <p>4. ç”Ÿå­˜5æ³¢åƒµå°¸æ”»å‡»è·èƒœ</p>
                </div>
            </div>
        </div>
        
        <div class="game-controls">
            <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
            <button id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
        
        <footer>
            <p>ã€Šç»æœ›é˜²çº¿ã€‹- æ¤ç‰©å¤§æˆ˜åƒµå°¸HTMLç‰ˆ | ä½¿ç”¨HTMLã€CSSå’ŒJavaScriptåˆ¶ä½œ</p>
        </footer>
    </div>
    
    <div class="message" id="gameOverMessage">
        <h2>æ¸¸æˆç»“æŸ</h2>
        <p>åƒµå°¸çªç ´äº†ä½ çš„é˜²çº¿ï¼</p>
        <p>ä½ åšæŒåˆ°äº†ç¬¬ <span id="finalLevel">1</span> å…³</p>
        <button id="tryAgainBtn">å†è¯•ä¸€æ¬¡</button>
    </div>
    
    <div class="message" id="levelCompleteMessage">
        <h2>æ­å–œï¼</h2>
        <p>ä½ æˆåŠŸé˜²å¾¡äº†æ‰€æœ‰åƒµå°¸ï¼</p>
        <p>å‡†å¤‡è¿›å…¥ä¸‹ä¸€å…³...</p>
        <button id="nextLevelBtn">ä¸‹ä¸€å…³</button>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let gameState = {
            sun: 150,
            currentLevel: 1,
            wave: 1,
            totalWaves: 5,
            zombiesRemaining: 10,
            gameActive: false,
            selectedPlant: 'sunflower',
            plants: [],
            zombies: [],
            projectiles: [],
            suns: [],
            cells: [],
            zombieSpawnInterval: null,
            sunSpawnInterval: null,
            gameLoop: null
        };

        // æ¤ç‰©æ•°æ®
        const plantsData = {
            sunflower: {
                name: 'å‘æ—¥è‘µ',
                cost: 50,
                emoji: 'ğŸŒ»',
                color: 'radial-gradient(circle at 30% 30%, #f6b93b, #e58e26)',
                hp: 100,
                ability: 'sunProducer',
                cooldown: 10000 // ç”Ÿäº§é˜³å…‰é—´éš”(ms)
            },
            peashooter: {
                name: 'è±Œè±†å°„æ‰‹',
                cost: 100,
                emoji: 'ğŸŒ±',
                color: 'radial-gradient(circle at 30% 30%, #78e08f, #38ada9)',
                hp: 200,
                ability: 'shooter',
                damage: 25,
                cooldown: 1500 // å°„å‡»é—´éš”(ms)
            },
            wallnut: {
                name: 'åšæœå¢™',
                cost: 50,
                emoji: 'ğŸŒ°',
                color: 'radial-gradient(circle at 30% 30%, #8B4513, #A0522D)',
                hp: 800,
                ability: 'blocker'
            },
            cherrybomb: {
                name: 'æ¨±æ¡ƒç‚¸å¼¹',
                cost: 150,
                emoji: 'ğŸ’£',
                color: 'radial-gradient(circle at 30% 30%, #e55039, #b71540)',
                hp: 100,
                ability: 'explosive',
                damage: 300,
                cooldown: 0
            }
        };

        // åƒµå°¸æ•°æ®
        const zombieData = {
            normal: {
                name: 'æ™®é€šåƒµå°¸',
                emoji: 'ğŸ§Ÿ',
                color: 'linear-gradient(to bottom, #3c6382, #0a3d62)',
                speed: 0.5, // åƒç´ /å¸§
                hp: 150,
                damage: 10,
                attackSpeed: 1000 // æ”»å‡»é—´éš”(ms)
            },
            conehead: {
                name: 'è·¯éšœåƒµå°¸',
                emoji: 'ğŸ§Ÿ',
                color: 'linear-gradient(to bottom, #786fa6, #574b90)',
                speed: 0.4,
                hp: 300,
                damage: 10,
                attackSpeed: 1000
            }
        };

        // DOMå…ƒç´ 
        const sunCountEl = document.getElementById('sunCount');
        const currentLevelEl = document.getElementById('currentLevel');
        const waveProgressEl = document.getElementById('waveProgress');
        const waveCountEl = document.getElementById('waveCount');
        const zombiesLeftEl = document.getElementById('zombiesLeft');
        const lawnGridEl = document.getElementById('lawnGrid');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const plantOptions = document.querySelectorAll('.plant-option');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const levelCompleteMessage = document.getElementById('levelCompleteMessage');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const nextLevelBtn = document.getElementById('nextLevelBtn');
        const finalLevelEl = document.getElementById('finalLevel');

        // åˆå§‹åŒ–æ¸¸æˆç½‘æ ¼
        function initLawnGrid() {
            lawnGridEl.innerHTML = '';
            gameState.cells = [];
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'lawn-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    cell.addEventListener('click', () => placePlant(row, col));
                    cell.addEventListener('mouseover', () => highlightCell(row, col, true));
                    cell.addEventListener('mouseout', () => highlightCell(row, col, false));
                    
                    lawnGridEl.appendChild(cell);
                    gameState.cells.push({
                        element: cell,
                        row: row,
                        col: col,
                        plant: null,
                        zombie: null
                    });
                }
            }
        }

        // é«˜äº®æ˜¾ç¤ºå•å…ƒæ ¼
        function highlightCell(row, col, highlight) {
            const cell = gameState.cells.find(c => c.row === row && c.col === col);
            if (cell) {
                if (highlight && !cell.plant) {
                    cell.element.classList.add('highlight');
                } else {
                    cell.element.classList.remove('highlight');
                }
            }
        }

        // é€‰æ‹©æ¤ç‰©
        plantOptions.forEach(option => {
            option.addEventListener('click', () => {
                plantOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                gameState.selectedPlant = option.dataset.plant;
            });
        });

        // æ”¾ç½®æ¤ç‰©
        function placePlant(row, col) {
            if (!gameState.gameActive) return;
            
            const cell = gameState.cells.find(c => c.row === row && c.col === col);
            if (!cell || cell.plant) return;
            
            const plantType = gameState.selectedPlant;
            const plantInfo = plantsData[plantType];
            
            if (gameState.sun < plantInfo.cost) {
                showMessage('é˜³å…‰ä¸è¶³ï¼');
                return;
            }
            
            // æ‰£é™¤é˜³å…‰
            updateSun(-plantInfo.cost);
            
            // åˆ›å»ºæ¤ç‰©å…ƒç´ 
            const plantEl = document.createElement('div');
            plantEl.className = 'plant';
            plantEl.dataset.type = plantType;
            plantEl.dataset.row = row;
            plantEl.dataset.col = col;
            plantEl.innerHTML = plantInfo.emoji;
            plantEl.style.background = plantInfo.color;
            plantEl.style.top = `${row * 100 + 10}px`;
            plantEl.style.left = `${col * 100 + 10}px`;
            
            document.getElementById('lawn').appendChild(plantEl);
            
            // ä¿å­˜æ¤ç‰©æ•°æ®
            const plant = {
                element: plantEl,
                type: plantType,
                row: row,
                col: col,
                hp: plantInfo.hp,
                maxHp: plantInfo.hp,
                lastActionTime: Date.now(),
                ability: plantInfo.ability,
                damage: plantInfo.damage || 0,
                cooldown: plantInfo.cooldown || 0
            };
            
            gameState.plants.push(plant);
            cell.plant = plant;
            
            // å¦‚æœæ˜¯æ¨±æ¡ƒç‚¸å¼¹ï¼Œç«‹å³çˆ†ç‚¸
            if (plantType === 'cherrybomb') {
                setTimeout(() => {
                    explodeCherryBomb(plant);
                }, 500);
            }
            
            // æ˜¾ç¤ºæ”¾ç½®æ•ˆæœ
            plantEl.style.transform = 'scale(1.2)';
            setTimeout(() => {
                plantEl.style.transform = 'scale(1)';
            }, 200);
        }

        // æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸
        function explodeCherryBomb(plant) {
            const bombDamage = plantsData.cherrybomb.damage;
            const bombRange = 150; // åƒç´ èŒƒå›´
            
            // çˆ†ç‚¸æ•ˆæœ
            plant.element.innerHTML = 'ğŸ’¥';
            plant.element.style.background = 'radial-gradient(circle, #ff3838, #ff0000)';
            plant.element.style.transform = 'scale(2)';
            plant.element.style.zIndex = 20;
            
            // å¯¹èŒƒå›´å†…çš„åƒµå°¸é€ æˆä¼¤å®³
            gameState.zombies.forEach(zombie => {
                const zombieRect = zombie.element.getBoundingClientRect();
                const plantRect = plant.element.getBoundingClientRect();
                
                const distance = Math.sqrt(
                    Math.pow(zombieRect.left - plantRect.left, 2) + 
                    Math.pow(zombieRect.top - plantRect.top, 2)
                );
                
                if (distance <= bombRange) {
                    zombie.hp -= bombDamage;
                    if (zombie.hp <= 0) {
                        removeZombie(zombie);
                    } else {
                        // æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
                        zombie.element.style.filter = 'brightness(1.5)';
                        setTimeout(() => {
                            zombie.element.style.filter = 'brightness(1)';
                        }, 200);
                    }
                }
            });
            
            // ç§»é™¤æ¤ç‰©
            setTimeout(() => {
                removePlant(plant);
            }, 300);
        }

        // ç§»é™¤æ¤ç‰©
        function removePlant(plant) {
            // ä»æ•°ç»„å’Œå•å…ƒæ ¼ä¸­ç§»é™¤
            gameState.plants = gameState.plants.filter(p => p !== plant);
            const cell = gameState.cells.find(c => c.row === plant.row && c.col === plant.col);
            if (cell) cell.plant = null;
            
            // ç§»é™¤DOMå…ƒç´ 
            if (plant.element && plant.element.parentNode) {
                plant.element.remove();
            }
        }

        // ç”Ÿæˆåƒµå°¸
        function spawnZombie() {
            if (!gameState.gameActive) return;
            
            const row = Math.floor(Math.random() * 5);
            const zombieType = Math.random() > 0.7 ? 'conehead' : 'normal';
            const zombieInfo = zombieData[zombieType];
            
            // åˆ›å»ºåƒµå°¸å…ƒç´ 
            const zombieEl = document.createElement('div');
            zombieEl.className = 'zombie';
            zombieEl.dataset.type = zombieType;
            zombieEl.dataset.row = row;
            zombieEl.innerHTML = zombieInfo.emoji;
            zombieEl.style.background = zombieInfo.color;
            zombieEl.style.top = `${row * 100 + 15}px`;
            
            document.getElementById('lawn').appendChild(zombieEl);
            
            // ä¿å­˜åƒµå°¸æ•°æ®
            const zombie = {
                element: zombieEl,
                type: zombieType,
                row: row,
                hp: zombieInfo.hp,
                maxHp: zombieInfo.hp,
                speed: zombieInfo.speed,
                damage: zombieInfo.damage,
                attackSpeed: zombieInfo.attackSpeed,
                lastAttackTime: 0,
                targetPlant: null
            };
            
            gameState.zombies.push(zombie);
            
            // æ›´æ–°å‰©ä½™åƒµå°¸æ•°é‡
            gameState.zombiesRemaining--;
            updateZombiesLeft();
            
            // å¦‚æœåƒµå°¸æ•°é‡ä¸º0ï¼Œè¿›å…¥ä¸‹ä¸€æ³¢
            if (gameState.zombiesRemaining <= 0) {
                nextWave();
            }
        }

        // ç§»é™¤åƒµå°¸
        function removeZombie(zombie) {
            // ä»æ•°ç»„ä¸­ç§»é™¤
            gameState.zombies = gameState.zombies.filter(z => z !== zombie);
            
            // å¦‚æœåƒµå°¸æœ‰ç›®æ ‡æ¤ç‰©ï¼Œæ¸…é™¤ç›®æ ‡
            if (zombie.targetPlant) {
                const plantCell = gameState.cells.find(c => 
                    c.row === zombie.targetPlant.row && 
                    c.col === zombie.targetPlant.col
                );
                if (plantCell) plantCell.zombie = null;
            }
            
            // ç§»é™¤DOMå…ƒç´ 
            if (zombie.element && zombie.element.parentNode) {
                // æ­»äº¡åŠ¨ç”»
                zombie.element.innerHTML = 'ğŸ’€';
                zombie.element.style.transform = 'rotate(90deg)';
                zombie.element.style.transition = 'transform 0.5s, opacity 0.5s';
                zombie.element.style.opacity = '0.5';
                
                setTimeout(() => {
                    if (zombie.element && zombie.element.parentNode) {
                        zombie.element.remove();
                    }
                }, 500);
            }
        }

        // ç”Ÿæˆé˜³å…‰
        function spawnSun() {
            if (!gameState.gameActive) return;
            
            const sunEl = document.createElement('div');
            sunEl.className = 'sun';
            sunEl.style.left = `${Math.random() * 80 + 10}%`;
            sunEl.style.top = `${Math.random() * 70 + 10}%`;
            
            sunEl.addEventListener('click', () => collectSun(sunEl));
            
            document.getElementById('lawn').appendChild(sunEl);
            
            gameState.suns.push({
                element: sunEl,
                value: 25,
                createdAt: Date.now()
            });
            
            // é˜³å…‰è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (sunEl.parentNode) {
                    sunEl.remove();
                    gameState.suns = gameState.suns.filter(s => s.element !== sunEl);
                }
            }, 10000);
        }

        // æ”¶é›†é˜³å…‰
        function collectSun(sunEl) {
            const sun = gameState.suns.find(s => s.element === sunEl);
            if (!sun) return;
            
            updateSun(sun.value);
            
            // æ”¶é›†åŠ¨ç”»
            sunEl.style.transform = 'scale(1.5)';
            sunEl.style.opacity = '0';
            
            setTimeout(() => {
                if (sunEl.parentNode) {
                    sunEl.remove();
                    gameState.suns = gameState.suns.filter(s => s.element !== sunEl);
                }
            }, 300);
        }

        // æ›´æ–°é˜³å…‰æ•°é‡
        function updateSun(amount) {
            gameState.sun += amount;
            sunCountEl.textContent = gameState.sun;
            
            // åŠ¨ç”»æ•ˆæœ
            if (amount > 0) {
                sunCountEl.style.transform = 'scale(1.3)';
                sunCountEl.style.color = '#f6b93b';
                setTimeout(() => {
                    sunCountEl.style.transform = 'scale(1)';
                    setTimeout(() => {
                        sunCountEl.style.color = '#f6b93b';
                    }, 100);
                }, 200);
            } else {
                sunCountEl.style.transform = 'scale(0.9)';
                sunCountEl.style.color = '#e55039';
                setTimeout(() => {
                    sunCountEl.style.transform = 'scale(1)';
                    setTimeout(() => {
                        sunCountEl.style.color = '#f6b93b';
                    }, 100);
                }, 200);
            }
        }

        // æ›´æ–°å‰©ä½™åƒµå°¸æ•°é‡
        function updateZombiesLeft() {
            zombiesLeftEl.textContent = gameState.zombiesRemaining;
            const progress = (gameState.totalWaves - gameState.zombiesRemaining / 2) / gameState.totalWaves * 100;
            waveProgressEl.style.width = `${Math.min(progress, 100)}%`;
            waveCountEl.textContent = `${gameState.wave}/${gameState.totalWaves}`;
        }

        // ä¸‹ä¸€æ³¢åƒµå°¸
        function nextWave() {
            if (gameState.wave >= gameState.totalWaves) {
                completeLevel();
                return;
            }
            
            gameState.wave++;
            gameState.zombiesRemaining = 10 + gameState.wave * 2;
            updateZombiesLeft();
            
            showMessage(`ç¬¬ ${gameState.wave} æ³¢åƒµå°¸å³å°†åˆ°æ¥ï¼`);
        }

        // å®Œæˆå…³å¡
        function completeLevel() {
            pauseGame();
            levelCompleteMessage.style.display = 'block';
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            pauseGame();
            finalLevelEl.textContent = gameState.currentLevel;
            gameOverMessage.style.display = 'block';
        }

        // å¼€å§‹ä¸‹ä¸€å…³
        function nextLevel() {
            gameState.currentLevel++;
            gameState.wave = 1;
            gameState.zombiesRemaining = 10;
            
            currentLevelEl.textContent = gameState.currentLevel;
            updateZombiesLeft();
            
            levelCompleteMessage.style.display = 'none';
            
            // æ¸…ç†æ¸¸æˆåŒºåŸŸ
            clearGameObjects();
            
            // å¼€å§‹æ–°å…³å¡
            setTimeout(() => {
                startGame();
            }, 1000);
        }

        // æ¸…ç†æ¸¸æˆå¯¹è±¡
        function clearGameObjects() {
            // æ¸…ç†æ¤ç‰©
            gameState.plants.forEach(plant => {
                if (plant.element && plant.element.parentNode) {
                    plant.element.remove();
                }
            });
            
            // æ¸…ç†åƒµå°¸
            gameState.zombies.forEach(zombie => {
                if (zombie.element && zombie.element.parentNode) {
                    zombie.element.remove();
                }
            });
            
            // æ¸…ç†é˜³å…‰
            gameState.suns.forEach(sun => {
                if (sun.element && sun.element.parentNode) {
                    sun.element.remove();
                }
            });
            
            // æ¸…ç†å­å¼¹
            gameState.projectiles.forEach(projectile => {
                if (projectile.element && projectile.element.parentNode) {
                    projectile.remove();
                }
            });
            
            // é‡ç½®æ•°ç»„
            gameState.plants = [];
            gameState.zombies = [];
            gameState.suns = [];
            gameState.projectiles = [];
            
            // é‡ç½®å•å…ƒæ ¼
            gameState.cells.forEach(cell => {
                cell.plant = null;
                cell.zombie = null;
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text) {
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.textContent = text;
            messageEl.style.position = 'absolute';
            messageEl.style.top = '50%';
            messageEl.style.left = '50%';
            messageEl.style.transform = 'translate(-50%, -50%)';
            messageEl.style.background = 'rgba(0,0,0,0.8)';
            messageEl.style.color = '#f6b93b';
            messageEl.style.padding = '20px';
            messageEl.style.borderRadius = '10px';
            messageEl.style.zIndex = '1000';
            messageEl.style.fontSize = '1.5rem';
            messageEl.style.fontWeight = 'bold';
            messageEl.style.textAlign = 'center';
            
            document.getElementById('lawn').appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 1500);
        }

        // æš‚åœæ¸¸æˆ
        function pauseGame() {
            gameState.gameActive = false;
            
            if (gameState.zombieSpawnInterval) {
                clearInterval(gameState.zombieSpawnInterval);
                gameState.zombieSpawnInterval = null;
            }
            
            if (gameState.sunSpawnInterval) {
                clearInterval(gameState.sunSpawnInterval);
                gameState.sunSpawnInterval = null;
            }
            
            if (gameState.gameLoop) {
                cancelAnimationFrame(gameState.gameLoop);
                gameState.gameLoop = null;
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (gameState.gameActive) return;
            
            gameState.gameActive = true;
            
            // åˆå§‹é˜³å…‰
            gameState.sun = 150;
            sunCountEl.textContent = gameState.sun;
            
            // å¼€å§‹ç”Ÿæˆåƒµå°¸
            gameState.zombieSpawnInterval = setInterval(() => {
                if (gameState.gameActive && gameState.zombiesRemaining > 0) {
                    spawnZombie();
                }
            }, 3000 - gameState.currentLevel * 200);
            
            // å¼€å§‹ç”Ÿæˆé˜³å…‰
            gameState.sunSpawnInterval = setInterval(() => {
                if (gameState.gameActive) {
                    spawnSun();
                }
            }, 5000);
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            gameLoop();
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            startBtn.textContent = 'æ¸¸æˆè¿›è¡Œä¸­...';
            startBtn.disabled = true;
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            pauseGame();
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState = {
                sun: 150,
                currentLevel: 1,
                wave: 1,
                totalWaves: 5,
                zombiesRemaining: 10,
                gameActive: false,
                selectedPlant: 'sunflower',
                plants: [],
                zombies: [],
                projectiles: [],
                suns: [],
                cells: gameState.cells,
                zombieSpawnInterval: null,
                sunSpawnInterval: null,
                gameLoop: null
            };
            
            // æ›´æ–°æ˜¾ç¤º
            sunCountEl.textContent = gameState.sun;
            currentLevelEl.textContent = gameState.currentLevel;
            updateZombiesLeft();
            
            // æ¸…ç†æ¸¸æˆåŒºåŸŸ
            clearGameObjects();
            
            // é‡ç½®æŒ‰é’®
            startBtn.textContent = 'å¼€å§‹æ¸¸æˆ';
            startBtn.disabled = false;
            
            // éšè—æ¶ˆæ¯æ¡†
            gameOverMessage.style.display = 'none';
            levelCompleteMessage.style.display = 'none';
            
            // é‡æ–°åˆå§‹åŒ–ç½‘æ ¼
            initLawnGrid();
            
            // é»˜è®¤é€‰æ‹©å‘æ—¥è‘µ
            plantOptions.forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.plant-sunflower').classList.add('selected');
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameState.gameActive) return;
            
            const currentTime = Date.now();
            
            // æ›´æ–°æ‰€æœ‰æ¤ç‰©
            gameState.plants.forEach(plant => {
                // æ£€æŸ¥æ¤ç‰©æ˜¯å¦å­˜æ´»
                if (plant.hp <= 0) {
                    removePlant(plant);
                    return;
                }
                
                // æ¤ç‰©èƒ½åŠ›
                if (plant.ability === 'sunProducer') {
                    if (currentTime - plant.lastActionTime > plant.cooldown) {
                        // äº§ç”Ÿé˜³å…‰
                        updateSun(25);
                        plant.lastActionTime = currentTime;
                        
                        // æ˜¾ç¤ºé˜³å…‰äº§ç”Ÿæ•ˆæœ
                        const sunEffect = document.createElement('div');
                        sunEffect.className = 'sun';
                        sunEffect.style.width = '20px';
                        sunEffect.style.height = '20px';
                        sunEffect.style.position = 'absolute';
                        sunEffect.style.left = `${plant.col * 100 + 40}px`;
                        sunEffect.style.top = `${plant.row * 100 + 40}px`;
                        sunEffect.style.zIndex = '10';
                        
                        document.getElementById('lawn').appendChild(sunEffect);
                        
                        // é˜³å…‰ä¸Šå‡åŠ¨ç”»
                        let top = plant.row * 100 + 40;
                        const animateSun = () => {
                            top -= 2;
                            sunEffect.style.top = `${top}px`;
                            
                            if (top > plant.row * 100 - 20) {
                                requestAnimationFrame(animateSun);
                            } else {
                                sunEffect.remove();
                            }
                        };
                        
                        animateSun();
                    }
                } else if (plant.ability === 'shooter') {
                    // æ£€æŸ¥å‰æ–¹æ˜¯å¦æœ‰åƒµå°¸
                    const zombieInRow = gameState.zombies.find(z => 
                        z.row === plant.row && 
                        z.element.offsetLeft < 800
                    );
                    
                    if (zombieInRow && currentTime - plant.lastActionTime > plant.cooldown) {
                        // å‘å°„è±Œè±†
                        shootPea(plant);
                        plant.lastActionTime = currentTime;
                    }
                }
            });
            
            // æ›´æ–°æ‰€æœ‰åƒµå°¸
            gameState.zombies.forEach(zombie => {
                // æ£€æŸ¥åƒµå°¸æ˜¯å¦å­˜æ´»
                if (zombie.hp <= 0) {
                    removeZombie(zombie);
                    return;
                }
                
                // è·å–åƒµå°¸å½“å‰ä½ç½®
                const currentLeft = parseInt(zombie.element.style.left) || 800;
                
                // æ£€æŸ¥å‰æ–¹æ˜¯å¦æœ‰æ¤ç‰©
                const cellCol = Math.floor((currentLeft - 10) / 100);
                const cell = gameState.cells.find(c => c.row === zombie.row && c.col === cellCol);
                
                if (cell && cell.plant) {
                    // æ”»å‡»æ¤ç‰©
                    if (!zombie.targetPlant) {
                        zombie.targetPlant = cell.plant;
                        cell.zombie = zombie;
                    }
                    
                    // æ”»å‡»å†·å´
                    if (currentTime - zombie.lastAttackTime > zombie.attackSpeed) {
                        cell.plant.hp -= zombie.damage;
                        zombie.lastAttackTime = currentTime;
                        
                        // æ˜¾ç¤ºæ¤ç‰©å—ä¼¤æ•ˆæœ
                        cell.plant.element.style.filter = 'brightness(1.5)';
                        setTimeout(() => {
                            if (cell.plant && cell.plant.element) {
                                cell.plant.element.style.filter = 'brightness(1)';
                            }
                        }, 200);
                        
                        // æ£€æŸ¥æ¤ç‰©æ˜¯å¦è¢«æ‘§æ¯
                        if (cell.plant.hp <= 0) {
                            zombie.targetPlant = null;
                            cell.zombie = null;
                        }
                    }
                } else {
                    // æ¸…é™¤ç›®æ ‡æ¤ç‰©
                    zombie.targetPlant = null;
                    if (cell) cell.zombie = null;
                    
                    // å‘å‰ç§»åŠ¨
                    const newLeft = currentLeft - zombie.speed;
                    zombie.element.style.left = `${newLeft}px`;
                    
                    // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å·¦ä¾§ï¼ˆæ¸¸æˆå¤±è´¥ï¼‰
                    if (newLeft <= 10) {
                        gameOver();
                    }
                }
            });
            
            // æ›´æ–°æ‰€æœ‰å­å¼¹
            gameState.projectiles.forEach((projectile, index) => {
                const currentLeft = parseInt(projectile.element.style.left) || projectile.startX;
                const newLeft = currentLeft + 5;
                
                if (newLeft > 900) {
                    // ç§»é™¤è¶…å‡ºè¾¹ç•Œçš„å­å¼¹
                    projectile.element.remove();
                    gameState.projectiles.splice(index, 1);
                } else {
                    projectile.element.style.left = `${newLeft}px`;
                    
                    // æ£€æŸ¥å­å¼¹æ˜¯å¦å‡»ä¸­åƒµå°¸
                    gameState.zombies.forEach(zombie => {
                        const zombieRect = zombie.element.getBoundingClientRect();
                        const projectileRect = projectile.element.getBoundingClientRect();
                        
                        // ç®€å•ç¢°æ’æ£€æµ‹
                        if (zombieRect.left < projectileRect.left + 10 && 
                            zombieRect.left + zombieRect.width > projectileRect.left &&
                            zombieRect.top < projectileRect.top + 10 &&
                            zombieRect.top + zombieRect.height > projectileRect.top) {
                            
                            // å‡»ä¸­åƒµå°¸
                            zombie.hp -= projectile.damage;
                            
                            // æ˜¾ç¤ºå‡»ä¸­æ•ˆæœ
                            projectile.element.style.background = '#ff0000';
                            projectile.element.style.transform = 'scale(1.5)';
                            
                            setTimeout(() => {
                                if (projectile.element.parentNode) {
                                    projectile.element.remove();
                                }
                            }, 100);
                            
                            gameState.projectiles.splice(index, 1);
                            
                            // æ£€æŸ¥åƒµå°¸æ˜¯å¦æ­»äº¡
                            if (zombie.hp <= 0) {
                                removeZombie(zombie);
                            }
                        }
                    });
                }
            });
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            gameState.gameLoop = requestAnimationFrame(gameLoop);
        }

        // å‘å°„è±Œè±†
        function shootPea(plant) {
            const projectileEl = document.createElement('div');
            projectileEl.className = 'projectile';
            projectileEl.style.background = '#78e08f';
            projectileEl.style.left = `${plant.col * 100 + 60}px`;
            projectileEl.style.top = `${plant.row * 100 + 40}px`;
            
            document.getElementById('lawn').appendChild(projectileEl);
            
            gameState.projectiles.push({
                element: projectileEl,
                damage: plant.damage,
                startX: plant.col * 100 + 60
            });
        }

        // äº‹ä»¶ç›‘å¬å™¨
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', restartGame);
        tryAgainBtn.addEventListener('click', () => {
            gameOverMessage.style.display = 'none';
            restartGame();
        });
        nextLevelBtn.addEventListener('click', nextLevel);

        // åˆå§‹åŒ–æ¸¸æˆ
        initLawnGrid();
    </script>
</body>
</html>