<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节奏方块大师</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            overflow-x: hidden;
        }
        
        .game-container {
            width: 100%;
            max-width: 500px;
            background: linear-gradient(180deg, #0d0d1a 0%, #1a1a2e 100%);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(76, 201, 240, 0.2), 0 15px 35px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            position: relative;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.1) 0%, rgba(247, 37, 133, 0.1) 100%);
            border-bottom: 2px solid rgba(76, 201, 240, 0.3);
        }
        
        h1 {
            color: #4cc9f0;
            font-size: 2.2rem;
            margin-bottom: 5px;
            text-shadow: 0 0 20px rgba(76, 201, 240, 0.5);
            letter-spacing: 3px;
        }
        
        .subtitle {
            color: #a9a9a9;
            font-size: 0.95rem;
        }
        
        .game-info {
            display: flex;
            justify-content: space-around;
            background: rgba(20, 20, 40, 0.9);
            padding: 15px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 3px;
        }
        
        .info-value {
            font-size: 1.6rem;
            font-weight: bold;
            background: linear-gradient(135deg, #4cc9f0, #f72585);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .game-area {
            position: relative;
            height: 500px;
            background: linear-gradient(180deg, #0a0a15 0%, #12121f 100%);
            overflow: hidden;
        }
        
        .lanes {
            display: flex;
            height: 100%;
            position: relative;
        }
        
        .lane {
            flex: 1;
            height: 100%;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            transition: background-color 0.1s ease;
        }
        
        .lane:last-child {
            border-right: none;
        }
        
        .lane.lane-0 { background: linear-gradient(180deg, transparent 0%, rgba(231, 76, 60, 0.05) 100%); }
        .lane.lane-1 { background: linear-gradient(180deg, transparent 0%, rgba(46, 204, 113, 0.05) 100%); }
        .lane.lane-2 { background: linear-gradient(180deg, transparent 0%, rgba(52, 152, 219, 0.05) 100%); }
        .lane.lane-3 { background: linear-gradient(180deg, transparent 0%, rgba(155, 89, 182, 0.05) 100%); }
        
        .lane.hit-flash {
            animation: laneFlash 0.15s ease-out;
        }
        
        .lane.miss-flash {
            animation: laneMissFlash 0.3s ease-out;
        }
        
        @keyframes laneFlash {
            0% { background-color: rgba(76, 201, 240, 0.3); }
            100% { background-color: transparent; }
        }
        
        @keyframes laneMissFlash {
            0% { background-color: rgba(244, 67, 54, 0.4); }
            100% { background-color: transparent; }
        }
        
        .note {
            position: absolute;
            width: 100%;
            height: 50px;
            border-radius: 8px;
            left: 0;
            top: -60px;
            opacity: 0.95;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: transform 0.05s ease;
        }
        
        .note.lane-0 {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 20px rgba(231, 76, 60, 0.5);
        }
        
        .note.lane-1 {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            box-shadow: 0 4px 20px rgba(46, 204, 113, 0.5);
        }
        
        .note.lane-2 {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.5);
        }
        
        .note.lane-3 {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 4px 20px rgba(155, 89, 182, 0.5);
        }
        
        .note.hit {
            animation: noteHit 0.3s ease-out forwards;
        }
        
        .note.miss {
            animation: noteMiss 0.5s ease-out forwards;
        }
        
        @keyframes noteHit {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        @keyframes noteMiss {
            0% { transform: scale(1); opacity: 0.5; filter: grayscale(100%); }
            100% { transform: translateY(50px) scale(0.8); opacity: 0; }
        }
        
        .judgement-zone {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            display: flex;
            z-index: 10;
        }
        
        .receptor {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(180deg, transparent 0%, rgba(20, 20, 40, 0.9) 100%);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.08s ease;
        }
        
        .receptor::before {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 90%;
            height: 60px;
            border-radius: 10px;
            opacity: 0.3;
            transition: all 0.1s ease;
        }
        
        .receptor:nth-child(1)::before { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .receptor:nth-child(2)::before { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .receptor:nth-child(3)::before { background: linear-gradient(135deg, #3498db, #2980b9); }
        .receptor:nth-child(4)::before { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        
        .receptor.pressed {
            background: rgba(76, 201, 240, 0.2);
            border-top-color: #4cc9f0;
        }
        
        .receptor.pressed::before {
            opacity: 0.8;
            transform: scale(1.05);
            box-shadow: 0 0 20px currentColor;
        }
        
        .key-label {
            font-size: 1.5rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.6);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            transition: all 0.1s ease;
        }
        
        .receptor.pressed .key-label {
            color: #fff;
            transform: scale(1.2);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        
        .hit-effect {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.4rem;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            z-index: 20;
        }
        
        .hit-effect.perfect {
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .hit-effect.great {
            color: #4cc9f0;
            text-shadow: 0 0 15px rgba(76, 201, 240, 0.6);
        }
        
        .hit-effect.miss {
            color: #f44336;
            text-shadow: 0 0 15px rgba(244, 67, 54, 0.6);
        }
        
        .hit-effect.show {
            animation: hitEffectShow 0.5s ease-out forwards;
        }
        
        @keyframes hitEffectShow {
            0% { opacity: 1; transform: translateX(-50%) translateY(0) scale(0.5); }
            50% { opacity: 1; transform: translateX(-50%) translateY(-10px) scale(1.2); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-30px) scale(1); }
        }
        
        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
            z-index: 15;
        }
        
        .combo-number {
            font-size: 4rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            opacity: 0;
            transition: all 0.15s ease;
        }
        
        .combo-number.show {
            animation: comboPulse 0.4s ease-out;
        }
        
        .combo-text {
            font-size: 1.2rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 5px;
            opacity: 0;
        }
        
        .combo-text.show {
            opacity: 1;
        }
        
        @keyframes comboPulse {
            0% { transform: scale(1.5); opacity: 0; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        
        .controls {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: rgba(20, 20, 40, 0.9);
            gap: 10px;
        }
        
        .control-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
        }
        
        .pause-btn {
            background: linear-gradient(135deg, #f72585, #b5179e);
            color: white;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #7209b7, #560bad);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .instructions {
            background: rgba(30, 30, 50, 0.9);
            padding: 20px;
            font-size: 0.9rem;
            line-height: 1.8;
        }
        
        .instructions h3 {
            color: #4cc9f0;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            color: #ccc;
        }
        
        .instructions kbd {
            background: rgba(76, 201, 240, 0.2);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: #4cc9f0;
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 20, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }
        
        .game-over-screen.show {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .game-over-screen h2 {
            font-size: 3rem;
            color: #f44336;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(244, 67, 54, 0.6);
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .game-over-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
        }
        
        .grade {
            font-size: 5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 40px currentColor;
        }
        
        .grade.s { color: #ffd700; }
        .grade.a { color: #4cc9f0; }
        .grade.b { color: #2ecc71; }
        .grade.c { color: #f39c12; }
        .grade.d { color: #e74c3c; }
        
        .restart-btn {
            padding: 18px 50px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(76, 201, 240, 0.5);
        }
        
        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem;
            font-weight: bold;
            color: #4cc9f0;
            text-shadow: 0 0 50px rgba(76, 201, 240, 0.8);
            z-index: 50;
            animation: countdownPulse 1s ease-out;
        }
        
        @keyframes countdownPulse {
            0% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        .speed-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #4cc9f0;
            border: 1px solid rgba(76, 201, 240, 0.3);
            z-index: 10;
        }
        
        .health-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(244, 67, 54, 0.3);
            z-index: 20;
        }
        
        .health-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #4cc9f0, #2ecc71, #ffd700);
            transition: width 0.2s ease;
        }
        
        @media (max-width: 500px) {
            .game-container {
                border-radius: 0;
                height: 100vh;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .game-area {
                height: calc(100vh - 280px);
            }
            
            .receptor {
                height: 70px;
            }
            
            .key-label {
                font-size: 1.2rem;
            }
            
            .control-btn {
                padding: 12px 8px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header>
            <h1><i class="fas fa-music"></i> 节奏方块大师</h1>
            <p class="subtitle">按下对应按键，接住掉落方块</p>
        </header>
        
        <div class="game-info">
            <div class="info-item">
                <div class="info-label">得分</div>
                <div class="info-value" id="score">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">连击</div>
                <div class="info-value" id="combo">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">最大连击</div>
                <div class="info-value" id="max-combo">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">准确率</div>
                <div class="info-value" id="accuracy">100%</div>
            </div>
        </div>
        
        <div class="game-area" id="game-area">
            <div class="health-bar">
                <div class="health-fill" id="health-fill"></div>
            </div>
            
            <div class="speed-indicator">
                <i class="fas fa-tachometer-alt"></i> <span id="speed-value">1.0x</span>
            </div>
            
            <div class="lanes" id="lanes">
                <div class="lane lane-0" data-lane="0"></div>
                <div class="lane lane-1" data-lane="1"></div>
                <div class="lane lane-2" data-lane="2"></div>
                <div class="lane lane-3" data-lane="3"></div>
            </div>
            
            <div class="judgement-zone" id="judgement-zone">
                <div class="receptor" data-lane="0">
                    <span class="key-label">D</span>
                    <div class="hit-effect perfect" id="hit-0">PERFECT</div>
                </div>
                <div class="receptor" data-lane="1">
                    <span class="key-label">F</span>
                    <div class="hit-effect perfect" id="hit-1">PERFECT</div>
                </div>
                <div class="receptor" data-lane="2">
                    <span class="key-label">J</span>
                    <div class="hit-effect perfect" id="hit-2">PERFECT</div>
                </div>
                <div class="receptor" data-lane="3">
                    <span class="key-label">K</span>
                    <div class="hit-effect perfect" id="hit-3">PERFECT</div>
                </div>
            </div>
            
            <div class="combo-display">
                <div class="combo-number" id="combo-number">10</div>
                <div class="combo-text">COMBO</div>
            </div>
            
            <div class="game-over-screen" id="game-over-screen">
                <h2>GAME OVER</h2>
                <div class="grade" id="grade">S</div>
                <div class="game-over-stats">
                    <div class="stat">
                        <div class="stat-value" id="final-score">0</div>
                        <div class="stat-label">得分</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="final-max-combo">0</div>
                        <div class="stat-label">最大连击</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="final-accuracy">0%</div>
                        <div class="stat-label">准确率</div>
                    </div>
                </div>
                <button class="restart-btn" id="restart-btn">
                    <i class="fas fa-redo"></i> 再来一次
                </button>
            </div>
        </div>
        
        <div class="controls">
            <button class="control-btn start-btn" id="start-btn">
                <i class="fas fa-play"></i> 开始
            </button>
            <button class="control-btn pause-btn" id="pause-btn" disabled>
                <i class="fas fa-pause"></i> 暂停
            </button>
            <button class="control-btn reset-btn" id="reset-btn">
                <i class="fas fa-undo"></i> 重置
            </button>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 游戏说明</h3>
            <ul>
                <li>当彩色方块掉落到按键区域时，按下对应的按键</li>
                <li><kbd>D</kbd> <kbd>F</kbd> <kbd>J</kbd> <kbd>K</kbd> 键分别对应4条轨道</li>
                <li>也可以直接点击屏幕上的按键区域</li>
                <li><strong>PERFECT</strong>: 完美命中 +10分 | <strong>GREAT</strong>: 良好 +5分</li>
                <li>错过方块会损失生命值，生命值耗尽游戏结束</li>
                <li>连续命中可获得更高分数和连击奖励</li>
            </ul>
        </div>
    </div>

    <script>
        // 游戏配置
        const config = {
            easy: {
                initialSpeed: 3,
                speedIncrement: 0.1,
                noteInterval: 600,
                maxHealth: 10
            },
            normal: {
                initialSpeed: 4.5,
                speedIncrement: 0.15,
                noteInterval: 400,
                maxHealth: 8
            },
            hard: {
                initialSpeed: 6,
                speedIncrement: 0.25,
                noteInterval: 250,
                maxHealth: 5
            }
        };

        // 判定区间（像素）
        const PERFECT_RANGE = 25;
        const GREAT_RANGE = 50;
        const HIT_WINDOW = 70;

        // 游戏状态
        let gameState = {
            score: 0,
            combo: 0,
            maxCombo: 0,
            totalNotes: 0,
            perfectHits: 0,
            greatHits: 0,
            missedNotes: 0,
            health: 10,
            maxHealth: 10,
            speed: 1,
            isRunning: false,
            isPaused: false,
            currentMode: 'easy',
            notes: [],
            lastNoteTime: 0,
            gameLoopId: null,
            speedIncreaseInterval: null,
            healthDecreaseInterval: null
        };

        // DOM 元素
        const scoreElement = document.getElementById('score');
        const comboElement = document.getElementById('combo');
        const maxComboElement = document.getElementById('max-combo');
        const accuracyElement = document.getElementById('accuracy');
        const speedValueElement = document.getElementById('speed-value');
        const healthFill = document.getElementById('health-fill');
        const lanesContainer = document.getElementById('lanes');
        const receptors = document.querySelectorAll('.receptor');
        const gameOverScreen = document.getElementById('game-over-screen');
        const comboNumber = document.getElementById('combo-number');
        const comboText = document.querySelector('.combo-text');

        // 控制按钮
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const restartBtn = document.getElementById('restart-btn');

        // 按键映射
        const keyMap = {
            'KeyD': 0,
            'KeyF': 1,
            'KeyJ': 2,
            'KeyK': 3
        };

        // 初始化游戏
        function initGame() {
            const modeConfig = config[gameState.currentMode];
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.totalNotes = 0;
            gameState.perfectHits = 0;
            gameState.greatHits = 0;
            gameState.missedNotes = 0;
            gameState.health = modeConfig.maxHealth;
            gameState.maxHealth = modeConfig.maxHealth;
            gameState.speed = modeConfig.initialSpeed;
            gameState.isRunning = false;
            gameState.isPaused = false;
            gameState.notes = [];
            gameState.lastNoteTime = 0;

            // 更新UI
            updateUI();

            // 清除所有方块
            document.querySelectorAll('.note').forEach(note => note.remove());

            // 隐藏游戏结束画面
            gameOverScreen.classList.remove('show');

            // 重置按钮状态
            startBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停';
        }

        // 更新UI
        function updateUI() {
            scoreElement.textContent = gameState.score;
            comboElement.textContent = gameState.combo;
            maxComboElement.textContent = gameState.maxCombo;
            
            // 计算准确率
            if (gameState.totalNotes > 0) {
                const accuracy = Math.round((gameState.perfectHits + gameState.greatHits * 0.5) / gameState.totalNotes * 100);
                accuracyElement.textContent = `${accuracy}%`;
            } else {
                accuracyElement.textContent = '100%';
            }
            
            speedValueElement.textContent = `${gameState.speed.toFixed(1)}x`;
            
            // 更新生命条
            const healthPercent = (gameState.health / gameState.maxHealth) * 100;
            healthFill.style.width = `${healthPercent}%`;
        }

        // 创建方块
        function createNote() {
            const laneIndex = Math.floor(Math.random() * 4);
            const lane = document.querySelector(`.lane-${laneIndex}`);
            
            const note = document.createElement('div');
            note.className = `note lane-${laneIndex}`;
            note.dataset.lane = laneIndex;
            note.dataset.y = -60;
            
            lane.appendChild(note);
            
            gameState.notes.push({
                element: note,
                lane: laneIndex,
                y: -60,
                hit: false
            });
            
            gameState.totalNotes++;
            
            return note;
        }

        // 处理按键/点击
        function handleInput(laneIndex) {
            if (!gameState.isRunning || gameState.isPaused) return;
            
            const receptor = document.querySelector(`.receptor[data-lane="${laneIndex}"]`);
            receptor.classList.add('pressed');
            setTimeout(() => receptor.classList.remove('pressed'), 100);
            
            // 找到该轨道最底部的未命中方块
            const laneNotes = gameState.notes.filter(n => n.lane === laneIndex && !n.hit);
            
            if (laneNotes.length === 0) return;
            
            // 找到最接近判定线的方块
            const targetNote = laneNotes.reduce((closest, note) => {
                const noteBottom = note.y + 50;
                const targetY = 420; // 判定线位置
                const noteDist = Math.abs(noteBottom - targetY);
                const closestDist = closest ? Math.abs(closest.y + 50 - targetY) : Infinity;
                return noteDist < closestDist ? note : closest;
            }, null);
            
            if (!targetNote) return;
            
            const noteBottom = targetNote.y + 50;
            const targetY = 420;
            const distance = Math.abs(noteBottom - targetY);
            
            if (distance > HIT_WINDOW) return; // 太远，不处理
            
            targetNote.hit = true;
            
            if (distance <= PERFECT_RANGE) {
                // PERFECT
                showHitEffect(laneIndex, 'PERFECT', 'perfect');
                gameState.score += 10 + Math.floor(gameState.combo / 10);
                gameState.perfectHits++;
                showComboEffect();
            } else if (distance <= GREAT_RANGE) {
                // GREAT
                showHitEffect(laneIndex, 'GREAT', 'great');
                gameState.score += 5 + Math.floor(gameState.combo / 10);
                gameState.greatHits++;
            }
            
            gameState.combo++;
            if (gameState.combo > gameState.maxCombo) {
                gameState.maxCombo = gameState.combo;
            }
            
            // 方块命中动画
            targetNote.element.classList.add('hit');
            setTimeout(() => targetNote.element.remove(), 300);
            
            // 轨道闪烁
            const lane = document.querySelector(`.lane-${laneIndex}`);
            lane.classList.add('hit-flash');
            setTimeout(() => lane.classList.remove('hit-flash'), 150);
            
            updateUI();
        }

        // 显示判定效果
        function showHitEffect(laneIndex, text, type) {
            const hitElement = document.getElementById(`hit-${laneIndex}`);
            hitElement.textContent = text;
            hitElement.className = `hit-effect ${type} show`;
            
            setTimeout(() => {
                hitElement.classList.remove('show');
            }, 500);
        }

        // 显示连击效果
        function showComboEffect() {
            if (gameState.combo < 5) return;
            
            comboNumber.textContent = gameState.combo;
            comboNumber.classList.add('show');
            comboText.classList.add('show');
            
            setTimeout(() => {
                comboNumber.classList.remove('show');
                comboText.classList.remove('show');
            }, 400);
        }

        // 更新方块位置
        function updateNotes() {
            const targetY = 420; // 判定线位置
            
            for (let i = gameState.notes.length - 1; i >= 0; i--) {
                const note = gameState.notes[i];
                
                if (note.hit) {
                    gameState.notes.splice(i, 1);
                    continue;
                }
                
                note.y += gameState.speed;
                note.element.style.top = `${note.y}px`;
                
                // 检查是否错过方块
                if (note.y > 500) {
                    note.element.classList.add('miss');
                    gameState.missedNotes++;
                    gameState.combo = 0;
                    gameState.health--;
                    
                    // 轨道闪烁红色
                    const lane = document.querySelector(`.lane-${note.lane}`);
                    lane.classList.add('miss-flash');
                    setTimeout(() => lane.classList.remove('miss-flash'), 300);
                    
                    showHitEffect(note.lane, 'MISS', 'miss');
                    
                    setTimeout(() => note.element.remove(), 500);
                    gameState.notes.splice(i, 1);
                    
                    // 检查游戏结束
                    if (gameState.health <= 0) {
                        endGame();
                        return;
                    }
                }
            }
            
            // 检查是否需要生成新方块
            const modeConfig = config[gameState.currentMode];
            const currentTime = Date.now();
            const adjustedInterval = modeConfig.noteInterval / (gameState.speed / modeConfig.initialSpeed);
            
            if (currentTime - gameState.lastNoteTime > adjustedInterval) {
                createNote();
                gameState.lastNoteTime = currentTime;
            }
            
            updateUI();
        }

        // 游戏主循环
        function gameLoop() {
            if (!gameState.isRunning || gameState.isPaused) return;
            
            updateNotes();
            
            gameState.gameLoopId = requestAnimationFrame(gameLoop);
        }

        // 开始游戏
        function startGame() {
            if (gameState.isRunning) return;
            
            gameState.isRunning = true;
            gameState.isPaused = false;
            gameState.lastNoteTime = Date.now();
            
            // 倒计时
            showCountdown(() => {
                gameLoop();
                
                // 开始加速计时
                gameState.speedIncreaseInterval = setInterval(() => {
                    gameState.speed += config[gameState.currentMode].speedIncrement;
                }, 5000);
            });
            
            startBtn.innerHTML = '<i class="fas fa-play"></i> 游戏中...';
            startBtn.disabled = true;
            pauseBtn.disabled = false;
        }

        // 显示倒计时
        function showCountdown(callback) {
            const gameArea = document.getElementById('game-area');
            const countdown = document.createElement('div');
            countdown.className = 'countdown';
            countdown.textContent = '3';
            gameArea.appendChild(countdown);
            
            let count = 3;
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdown.textContent = count;
                    countdown.style.animation = 'none';
                    countdown.offsetHeight; // 触发重绘
                    countdown.style.animation = 'countdownPulse 1s ease-out';
                } else if (count === 0) {
                    countdown.textContent = 'GO!';
                    countdown.style.color = '#2ecc71';
                } else {
                    countdown.remove();
                    clearInterval(countdownInterval);
                    callback();
                }
            }, 1000);
        }

        // 暂停/继续游戏
        function togglePause() {
            if (!gameState.isRunning) return;
            
            gameState.isPaused = !gameState.isPaused;
            
            if (gameState.isPaused) {
                cancelAnimationFrame(gameState.gameLoopId);
                clearInterval(gameState.speedIncreaseInterval);
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> 继续';
            } else {
                gameState.lastNoteTime = Date.now();
                gameLoop();
                gameState.speedIncreaseInterval = setInterval(() => {
                    gameState.speed += config[gameState.currentMode].speedIncrement;
                }, 5000);
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停';
            }
        }

        // 结束游戏
        function endGame() {
            gameState.isRunning = false;
            gameState.isPaused = false;
            
            cancelAnimationFrame(gameState.gameLoopId);
            clearInterval(gameState.speedIncreaseInterval);
            
            // 计算最终统计
            const totalHits = gameState.perfectHits + gameState.greatHits;
            const accuracy = gameState.totalNotes > 0 
                ? Math.round((gameState.perfectHits + gameState.greatHits * 0.5) / gameState.totalNotes * 100) 
                : 0;
            
            // 评级
            let grade, gradeClass;
            if (accuracy >= 95 && gameState.missedNotes === 0) {
                grade = 'S'; gradeClass = 's';
            } else if (accuracy >= 90) {
                grade = 'A'; gradeClass = 'a';
            } else if (accuracy >= 80) {
                grade = 'B'; gradeClass = 'b';
            } else if (accuracy >= 70) {
                grade = 'C'; gradeClass = 'c';
            } else {
                grade = 'D'; gradeClass = 'd';
            }
            
            // 更新游戏结束画面
            document.getElementById('grade').textContent = grade;
            document.getElementById('grade').className = `grade ${gradeClass}`;
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('final-max-combo').textContent = gameState.maxCombo;
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;
            
            gameOverScreen.classList.add('show');
            
            startBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
            startBtn.disabled = false;
            pauseBtn.disabled = true;
        }

        // 事件监听器
        receptors.forEach(receptor => {
            receptor.addEventListener('click', () => {
                const laneIndex = parseInt(receptor.dataset.lane);
                handleInput(laneIndex);
            });
            
            // 触摸支持
            receptor.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const laneIndex = parseInt(receptor.dataset.lane);
                handleInput(laneIndex);
            });
        });

        // 键盘控制
        document.addEventListener('keydown', (event) => {
            if (keyMap.hasOwnProperty(event.code)) {
                event.preventDefault();
                handleInput(keyMap[event.code]);
            }
            
            // 空格键暂停
            if (event.code === 'Space' && gameState.isRunning) {
                event.preventDefault();
                togglePause();
            }
        });

        // 按钮事件
        startBtn.addEventListener('click', startGame);
        pauseBtn.addEventListener('click', togglePause);
        resetBtn.addEventListener('click', initGame);
        restartBtn.addEventListener('click', initGame);

        // 初始化
        initGame();
    </script>
</body>
</html>
